{
    "on_insert": [
        {
            "type": "sql",
            "sql": "DO $$\nDECLARE\n  V_COUNTER integer;\n  V_CODE varchar(2);\n  V_ODG_NO varchar(2);\n  V_RESGRP_CD varchar(2);\n  V_RESLIN_CD varchar(2);\n  V_STATUS_CD varchar(1);\n  V_DBA_CD integer;\n  V_PORTF_PROJ_CD varchar(1);\n  V_DESCRIPTION varchar(500);\n  V_RESLIN_DESC varchar(60);\n  V_THEME_DESC_LENGTH integer;\n  V_D_REGISTRAT_DATE date;\n  V_D_INS_DATE date;\n  V_FUTURE_REGISTRAT date;\n  V_VALID_TO date;\n  V_USERID varchar(30);\n  V_IS_ADMIN_CNT integer := 0;\n  V_SEC_MOL_CNT integer := 0;\n  V_MOLECULE_ID varchar(5);\n  V_MOLECULE_RG_NO varchar(20);\n  V_MOLEC_IN_LIC_PRTNR varchar(15);\n  V_NEW_RG_NO TEXT;\n  V_COMPARATOR_IND TEXT;\n  V_THEME_DESC_PROPOSAL TEXT;\n  V_SHORT_NAME varchar(30);\n  V_EVOLVED_NMP_CNT integer;\n  V_TRADEMARK_NO TEXT;\n  V_MOLECULE_TYPE_ID TEXT;\n  V_PHARMACOLOGICAL_TYPE_ID TEXT;\n  C_MOLECULE_TYPE_ID CONSTANT TEXT := 99;\n  C_PHARMACOLOGICAL_TYPE_ID CONSTANT TEXT := 19;\n  INVALID_THEME_NO EXCEPTION;\n  DELETE_NO_MORE_POSSIBLE EXCEPTION;\n  THEME_NO_ONLY_INSERT EXCEPTION;\n  DESCRIPTION_TOO_LONG EXCEPTION;\n  THEME_DESC_PROPOSAL_TOO_LONG EXCEPTION;\n  THEME_DESC_ALT_TOO_LONG EXCEPTION;\n  THEME_NO_CANNOT_BE_INSERTED EXCEPTION;\n  ONLYONEOFFICIALCHANGEPERDAY EXCEPTION;\n  INSERTSMUSTBEOFFICIAL EXCEPTION;\n  THEMEDESCRIPTIONMANDATORY EXCEPTION;\n  THEME_DESC_NOT_UNIQUE EXCEPTION;\n  IN_PREP_NOT_PORTF_PROJ EXCEPTION;\n  IN_PREP_NOT_CLOSED EXCEPTION;\n  INVALID_MOLECULE_ID EXCEPTION;\n  SEC_MOL_LIST_NOT_EMPTY EXCEPTION;\n  ADMIN_UPDATE_ONLY EXCEPTION;\n  PORTF_PROJ_MOL_CRE_ERR EXCEPTION;\n  DEBUGGING EXCEPTION;\nBEGIN\n  SELECT COALESCE(TXO_SECURITY.GET_USERID, current_user) INTO V_USERID ;\n  SELECT COUNT(*) INTO V_IS_ADMIN_CNT FROM TXO_USERS_ROLES_MAP WHERE ROLE_ID IN (315) AND USERID = V_USERID;\n  SELECT NEW_RG_NO INTO V_NEW_RG_NO FROM ( SELECT NEW_RG_NO FROM ( SELECT ROWNUM AS NEW_RG_NO  /* CONNECT BY - replace with recursive CTE */ 1 = 1 AND ROWNUM <= 6999 ) WHERE NEW_RG_NO > 5999 MINUS SELECT CAST(RG_NO) FROM V_THEME_MOLECULES ) WHERE ROWNUM = 1;\n  IF (:NEW.IN_PREP_IND = 'Y') THEN\n    IF (:NEW.PORTF_PROJ_CD <> 'Y') THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: In-prep theme must be portfolio project';\n    END IF;\n    IF (:NEW.STATUS_DESC <> 'CLOSED' AND V_IS_ADMIN_CNT = 0) THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: In-prep status validation failed';\n    END IF;\n    IF (:NEW.MOLECULE_ID IS NULL) THEN\n      PERFORM txo_util.set_warning();\n    END IF;\n  END IF;\n  IF (:NEW.MOLECULE_ID IS NOT NULL) THEN\n    BEGIN\n      SELECT RG_NO, M.COMPARATOR_IND INTO V_MOLECULE_RG_NO, V_COMPARATOR_IND FROM V_THEME_MOLECULES M WHERE MOLECULE_ID = :NEW.MOLECULE_ID AND M.VALID_IND = 'Y';\n      EXCEPTION\n        WHEN NO_DATA_FOUND THEN\n          RAISE EXCEPTION 'This is not a valid Molecule ID';\n    END;\n    IF (V_MOLECULE_RG_NO IS NULL) THEN\n      IF (V_COMPARATOR_IND = 'Y') THEN\n        NULL;\n      ELSE\n        UPDATE V_THEME_MOLECULES SET RG_NO = V_NEW_RG_NO WHERE MOLECULE_ID = :NEW.MOLECULE_ID;\n      END IF;\n    END IF;\n  END IF;\n  IF (:NEW.STATUS_DESC IS NOT NULL) THEN\n    SELECT STATUS_CD INTO V_STATUS_CD FROM MDM_V_THEME_STATUS WHERE STATE_DESC = :NEW.STATUS_DESC;\n  ELSE\n  END IF;\n  IF (:NEW.DBA_DESC_CONCAT IS NOT NULL) THEN\n    SELECT DBA_CD INTO V_DBA_CD FROM MDM_V_DISEASE_BIOLOGY_AREAS WHERE DBA_SHORT_DESC || ' - ' || DBA_DESC = :NEW.DBA_DESC_CONCAT;\n  ELSE\n  END IF;\n  IF (:NEW.OFFICIAL_IND = 'N') THEN\n  ELSE\n  END IF;\n  IF (:NEW.MANUAL_SHORT_DESC IS NULL AND LENGTH(V_THEME_DESC_PROPOSAL) > 30) THEN\n    RAISE EXCEPTION 'The automatically generated Short Description Proposal is too long';\n  END IF;\n  IF TRUE THEN\n    IF (:NEW.IN_PREP_IND = 'N' AND V_IS_ADMIN_CNT = 0) THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: Admin access required for this operation';\n    END IF;\n    IF (:NEW.PORTF_PROJ_CD = 'Y' AND :NEW.MOLECULE_ID IS NULL) THEN\n      IF (COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL) IS NULL) THEN\n        RAISE EXCEPTION 'MDM_V_THEMES_IOF: Portfolio project molecule creation error';\n      ELSE\n        INSERT INTO MDM_V_THEME_MOLECULES_MTN( MOLECULE_DESC, VALID_IND, RG_NO, CANCER_IMMUNOTHERAPY_IND, MOLECULE_TYPE_ID, PHARMACOLOGICAL_TYPE_ID ) VALUES ( COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL), 'Y', V_NEW_RG_NO, 'N', C_MOLECULE_TYPE_ID, C_PHARMACOLOGICAL_TYPE_ID );\n        SELECT MOLECULE_ID INTO V_MOLECULE_ID FROM V_THEME_MOLECULES WHERE MOLECULE_DESC = COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL) AND VALID_IND = 'Y' AND RG_NO = V_NEW_RG_NO AND CANCER_IMMUNOTHERAPY_IND = 'N' AND MOLECULE_TYPE_ID = C_MOLECULE_TYPE_ID AND PHARMACOLOGICAL_TYPE_ID = C_PHARMACOLOGICAL_TYPE_ID;\n        INSERT INTO THEME_MOLECULE_MAP TMMAP( TMMAP.THEME_NO, TMMAP.MOLECULE_ID, TMMAP.MOLECULE_SEQ_NO, TMMAP.VALID_IND ) VALUES ( :NEW.THEME_NO, V_MOLECULE_ID, 1, 'Y' );\n      END IF;\n    END IF;\n    CASE\n      WHEN  THEN\n        IF (SUBSTRING(:NEW.THEME_NO, 1, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 2, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 3, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 4, 1) NOT BETWEEN 0 AND 9) THEN\n          RAISE EXCEPTION 'This is not a valid Theme No';\n        END IF;\n      WHEN  THEN\n        IF (SUBSTRING(:NEW.THEME_NO, 1, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 2, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 3, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 4, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 5, 1) NOT BETWEEN 0 AND 9) THEN\n          RAISE EXCEPTION 'This is not a valid Theme No';\n        END IF;\n      ELSE\n        RAISE EXCEPTION 'This is not a valid Theme No';\n    END CASE;\n    SELECT COUNT(T.THEME_NO) INTO V_COUNTER FROM ( SELECT THEME_NO FROM V_THEMES UNION ALL SELECT THEME_NO FROM GMD.THEMES_ARCHIVE )                  T WHERE T.THEME_NO = :NEW.THEME_NO;\n    IF (V_COUNTER > 0) THEN\n      RAISE EXCEPTION 'This Theme No already exists';\n    END IF;\n    IF (:NEW.OFFICIAL_IND = 'N') THEN\n      RAISE EXCEPTION 'New Themes can only be inserted by Official Changes';\n    END IF;\n    IF (UPPER(:NEW.PORTF_PROJ_CD) = 'N') THEN\n      IF (:NEW.THEME_DESC IS NULL OR LENGTH(:NEW.THEME_DESC) = 0) THEN\n        RAISE EXCEPTION 'If Pharma Rx Portfolio Project is set to \"No\", then the Theme Description must be filled';\n      END IF;\n    END IF;\n    IF (UPPER(:NEW.PORTF_PROJ_CD) = 'Y') THEN\n      IF (LENGTH(V_DESCRIPTION) > 90) THEN\n        RAISE EXCEPTION 'The automatically generated Theme Description is too long';\n      END IF;\n    ELSE\n    END IF;\n    SELECT COUNT(T.THEME_NO) INTO V_COUNTER FROM V_THEMES T WHERE T.THEME_DESC = V_DESCRIPTION;\n    IF (V_COUNTER > 0) THEN\n      RAISE EXCEPTION 'This Theme Description already exists';\n    END IF;\n    INSERT INTO GMD.THEMES( THEME_NO, REGISTRAT_DATE, ODG_NO, RESGRP_CD, RESLIN_CD, THEME_DESC, SHORT_NAME, STATUS_CD, DBA_CD, IN_PREP_IND, PROD_SHORT_CD, TRADEMARK_NO, BIO_ACTIVITY, APPLICANT, CONTACT, REGISTRAR, LINE_EXT_INFO, PORTF_PROJ_CD, CO_DEV_PRTNR, TECHNOLOGY_PRTNR, OFFICIAL_IND, CO_MAR_PRTNR, VALID_TO, PORTF_DA_GROUP_ID, MANUAL_SHORT_DESC ) VALUES ( :NEW.THEME_NO, V_D_REGISTRAT_DATE, V_ODG_NO, V_RESGRP_CD, V_RESLIN_CD, V_DESCRIPTION, V_SHORT_NAME, V_STATUS_CD, V_DBA_CD, :NEW.IN_PREP_IND, :NEW.PROD_SHORT_CD, :NEW.TRADEMARK_NO, :NEW.BIO_ACTIVITY, :NEW.APPLICANT, :NEW.CONTACT, TXO_UTIL.GET_USERID, :NEW.LINE_EXT_INFO, V_PORTF_PROJ_CD, :NEW.CO_DEV_PRTNR, :NEW.TECHNOLOGY_PRTNR, :NEW.OFFICIAL_IND, :NEW.CO_MAR_PRTNR, V_VALID_TO, :NEW.PORTF_DA_GROUP_ID, :NEW.MANUAL_SHORT_DESC );\n    IF (:OLD.MOLECULE_ID IS NULL AND :NEW.MOLECULE_ID IS NOT NULL) THEN\n      INSERT INTO MDM_V_THEME_MOLECULE_MAP_MTN A( A.THEME_NO, A.MOLECULE_ID, A.MOLECULE_SEQ_NO, A.VALID_IND ) VALUES ( :NEW.THEME_NO, V_MOLECULE_ID, 1, 'Y' );\n    END IF;\n  END IF;\n  IF ( OR ) THEN\n    IF (:NEW.PROPOSAL_ID IS NOT NULL AND :OLD.PROPOSAL_ID IS NULL) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID AND PROPOSAL_STATUS_CD = 'E';\n      IF (V_EVOLVED_NMP_CNT = 0) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'E', EVOLVED_THEME_NO = :NEW.THEME_NO, PROPOSAL_NAME = V_SHORT_NAME, REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID;\n      END IF;\n    ELSE\n      IF (:NEW.PROPOSAL_ID IS NULL AND :OLD.PROPOSAL_ID IS NOT NULL) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'A', EVOLVED_THEME_NO = NULL WHERE PROPOSAL_ID = :OLD.PROPOSAL_ID;\n      ELSE\n        IF (:NEW.PROPOSAL_ID IS NOT NULL AND :OLD.PROPOSAL_ID IS NOT NULL AND :NEW.PROPOSAL_ID <> :OLD.PROPOSAL_ID) THEN\n          UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'A', EVOLVED_THEME_NO = NULL WHERE PROPOSAL_ID = :OLD.PROPOSAL_ID;\n          UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'E', EVOLVED_THEME_NO = :NEW.THEME_NO, PROPOSAL_NAME = V_SHORT_NAME, REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID;\n        END IF;\n      END IF;\n    END IF;\n    IF (COALESCE(:NEW.PROPOSAL_ID, 0) = COALESCE(:OLD.PROPOSAL_ID, 0) AND COALESCE(:OLD.SHORT_NAME, '-') <> COALESCE(V_SHORT_NAME, '-')) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN NMP WHERE NMP.EVOLVED_THEME_NO =:NEW.THEME_NO AND NMP.PROPOSAL_STATUS_CD = 'E';\n      IF (V_EVOLVED_NMP_CNT > 0) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN NMP SET NMP.PROPOSAL_NAME = V_SHORT_NAME, NMP.REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE NMP.EVOLVED_THEME_NO =:NEW.THEME_NO AND NMP.PROPOSAL_STATUS_CD = 'E';\n      END IF;\n    END IF;\n  END IF;\n  IF ( AND :NEW.THEME_NO IS NOT NULL AND GMD_UTIL_THEMES.GET_THEMES_RANGE_AUTOMATIC_NMP(:NEW.THEME_NO) = 'Y') THEN\n    IF (:NEW.PROPOSAL_ID IS NOT NULL) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID AND PROPOSAL_NAME = V_SHORT_NAME AND PROPOSAL_STATUS_CD = 'E';\n    END IF;\n    IF (:NEW.PROPOSAL_ID IS NULL OR (:NEW.PROPOSAL_ID IS NOT NULL AND V_EVOLVED_NMP_CNT = 0)) THEN\n      IF (:NEW.MOLECULE_ID IS NOT NULL) THEN\n        BEGIN\n          SELECT PHARMACOLOGICAL_TYPE_ID, MOLECULE_TYPE_ID INTO V_PHARMACOLOGICAL_TYPE_ID, V_MOLECULE_TYPE_ID FROM V_THEME_MOLECULES M WHERE MOLECULE_ID = :NEW.MOLECULE_ID AND M.VALID_IND = 'Y';\n          EXCEPTION\n            WHEN NO_DATA_FOUND THEN\n              RAISE EXCEPTION 'This is not a valid Molecule ID';\n        END;\n      END IF;\n      INSERT INTO MDM_V_NEW_MEDICINE_PROPOSALS_MTN ( PROPOSAL_STATUS_CD, EVOLVED_THEME_NO, PROPOSAL_NAME, PHARMACOLOGICAL_TYPE_ID, MOLECULE_TYPE_ID, REASON_FOR_CHANGE ) VALUES ( 'E', :NEW.THEME_NO, V_SHORT_NAME, COALESCE(V_PHARMACOLOGICAL_TYPE_ID, C_PHARMACOLOGICAL_TYPE_ID), COALESCE(V_MOLECULE_TYPE_ID, C_MOLECULE_TYPE_ID), '** Automatic creation of nmp for early development themes **' );\n    END IF;\n  END IF;\n  EXCEPTION\n    WHEN ADMIN_UPDATE_ONLY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN IN_PREP_NOT_PORTF_PROJ THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN IN_PREP_NOT_CLOSED THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INVALID_MOLECULE_ID THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN SEC_MOL_LIST_NOT_EMPTY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INVALID_THEME_NO THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DELETE_NO_MORE_POSSIBLE THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_NO_ONLY_INSERT THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DESCRIPTION_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_PROPOSAL_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_ALT_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_NO_CANNOT_BE_INSERTED THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN ONLYONEOFFICIALCHANGEPERDAY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INSERTSMUSTBEOFFICIAL THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEMEDESCRIPTIONMANDATORY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_NOT_UNIQUE THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN PORTF_PROJ_MOL_CRE_ERR THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DEBUGGING THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\nEND;\nEND $$;"
        }
    ],
    "on_update": [
        {
            "type": "sql",
            "sql": "DO $$\nDECLARE\n  V_COUNTER integer;\n  V_CODE varchar(2);\n  V_ODG_NO varchar(2);\n  V_RESGRP_CD varchar(2);\n  V_RESLIN_CD varchar(2);\n  V_STATUS_CD varchar(1);\n  V_DBA_CD integer;\n  V_PORTF_PROJ_CD varchar(1);\n  V_DESCRIPTION varchar(500);\n  V_RESLIN_DESC varchar(60);\n  V_THEME_DESC_LENGTH integer;\n  V_D_REGISTRAT_DATE date;\n  V_D_INS_DATE date;\n  V_FUTURE_REGISTRAT date;\n  V_VALID_TO date;\n  V_USERID varchar(30);\n  V_IS_ADMIN_CNT integer := 0;\n  V_SEC_MOL_CNT integer := 0;\n  V_MOLECULE_ID varchar(5);\n  V_MOLECULE_RG_NO varchar(20);\n  V_MOLEC_IN_LIC_PRTNR varchar(15);\n  V_NEW_RG_NO TEXT;\n  V_COMPARATOR_IND TEXT;\n  V_THEME_DESC_PROPOSAL TEXT;\n  V_SHORT_NAME varchar(30);\n  V_EVOLVED_NMP_CNT integer;\n  V_TRADEMARK_NO TEXT;\n  V_MOLECULE_TYPE_ID TEXT;\n  V_PHARMACOLOGICAL_TYPE_ID TEXT;\n  C_MOLECULE_TYPE_ID CONSTANT TEXT := 99;\n  C_PHARMACOLOGICAL_TYPE_ID CONSTANT TEXT := 19;\n  INVALID_THEME_NO EXCEPTION;\n  DELETE_NO_MORE_POSSIBLE EXCEPTION;\n  THEME_NO_ONLY_INSERT EXCEPTION;\n  DESCRIPTION_TOO_LONG EXCEPTION;\n  THEME_DESC_PROPOSAL_TOO_LONG EXCEPTION;\n  THEME_DESC_ALT_TOO_LONG EXCEPTION;\n  THEME_NO_CANNOT_BE_INSERTED EXCEPTION;\n  ONLYONEOFFICIALCHANGEPERDAY EXCEPTION;\n  INSERTSMUSTBEOFFICIAL EXCEPTION;\n  THEMEDESCRIPTIONMANDATORY EXCEPTION;\n  THEME_DESC_NOT_UNIQUE EXCEPTION;\n  IN_PREP_NOT_PORTF_PROJ EXCEPTION;\n  IN_PREP_NOT_CLOSED EXCEPTION;\n  INVALID_MOLECULE_ID EXCEPTION;\n  SEC_MOL_LIST_NOT_EMPTY EXCEPTION;\n  ADMIN_UPDATE_ONLY EXCEPTION;\n  PORTF_PROJ_MOL_CRE_ERR EXCEPTION;\n  DEBUGGING EXCEPTION;\nBEGIN\n  SELECT COALESCE(TXO_SECURITY.GET_USERID, current_user) INTO V_USERID ;\n  SELECT COUNT(*) INTO V_IS_ADMIN_CNT FROM TXO_USERS_ROLES_MAP WHERE ROLE_ID IN (315) AND USERID = V_USERID;\n  SELECT NEW_RG_NO INTO V_NEW_RG_NO FROM ( SELECT NEW_RG_NO FROM ( SELECT ROWNUM AS NEW_RG_NO  /* CONNECT BY - replace with recursive CTE */ 1 = 1 AND ROWNUM <= 6999 ) WHERE NEW_RG_NO > 5999 MINUS SELECT CAST(RG_NO) FROM V_THEME_MOLECULES ) WHERE ROWNUM = 1;\n  IF (:NEW.IN_PREP_IND = 'Y') THEN\n    IF (:NEW.PORTF_PROJ_CD <> 'Y') THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: In-prep theme must be portfolio project';\n    END IF;\n    IF (:NEW.STATUS_DESC <> 'CLOSED' AND V_IS_ADMIN_CNT = 0) THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: In-prep status validation failed';\n    END IF;\n    IF (:NEW.MOLECULE_ID IS NULL) THEN\n      PERFORM txo_util.set_warning();\n    END IF;\n  END IF;\n  IF (:NEW.MOLECULE_ID IS NOT NULL) THEN\n    BEGIN\n      SELECT RG_NO, M.COMPARATOR_IND INTO V_MOLECULE_RG_NO, V_COMPARATOR_IND FROM V_THEME_MOLECULES M WHERE MOLECULE_ID = :NEW.MOLECULE_ID AND M.VALID_IND = 'Y';\n      EXCEPTION\n        WHEN NO_DATA_FOUND THEN\n          RAISE EXCEPTION 'This is not a valid Molecule ID';\n    END;\n    IF (V_MOLECULE_RG_NO IS NULL) THEN\n      IF (V_COMPARATOR_IND = 'Y') THEN\n        NULL;\n      ELSE\n        UPDATE V_THEME_MOLECULES SET RG_NO = V_NEW_RG_NO WHERE MOLECULE_ID = :NEW.MOLECULE_ID;\n      END IF;\n    END IF;\n  END IF;\n  IF (:NEW.STATUS_DESC IS NOT NULL) THEN\n    SELECT STATUS_CD INTO V_STATUS_CD FROM MDM_V_THEME_STATUS WHERE STATE_DESC = :NEW.STATUS_DESC;\n  ELSE\n  END IF;\n  IF (:NEW.DBA_DESC_CONCAT IS NOT NULL) THEN\n    SELECT DBA_CD INTO V_DBA_CD FROM MDM_V_DISEASE_BIOLOGY_AREAS WHERE DBA_SHORT_DESC || ' - ' || DBA_DESC = :NEW.DBA_DESC_CONCAT;\n  ELSE\n  END IF;\n  IF (:NEW.OFFICIAL_IND = 'N') THEN\n  ELSE\n  END IF;\n  IF (:NEW.MANUAL_SHORT_DESC IS NULL AND LENGTH(V_THEME_DESC_PROPOSAL) > 30) THEN\n    RAISE EXCEPTION 'The automatically generated Short Description Proposal is too long';\n  END IF;\n  IF TRUE THEN\n    IF (:NEW.IN_PREP_IND = 'N' AND V_IS_ADMIN_CNT = 0) THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: Admin access required for this operation';\n    END IF;\n    IF (:NEW.PORTF_PROJ_CD = 'Y' AND :NEW.MOLECULE_ID IS NULL) THEN\n      IF (COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL) IS NULL) THEN\n        RAISE EXCEPTION 'MDM_V_THEMES_IOF: Portfolio project molecule creation error';\n      ELSE\n        INSERT INTO MDM_V_THEME_MOLECULES_MTN( MOLECULE_DESC, VALID_IND, RG_NO, CANCER_IMMUNOTHERAPY_IND, MOLECULE_TYPE_ID, PHARMACOLOGICAL_TYPE_ID ) VALUES ( COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL), 'Y', V_NEW_RG_NO, 'N', C_MOLECULE_TYPE_ID, C_PHARMACOLOGICAL_TYPE_ID );\n        SELECT MOLECULE_ID INTO V_MOLECULE_ID FROM V_THEME_MOLECULES WHERE MOLECULE_DESC = COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL) AND VALID_IND = 'Y' AND RG_NO = V_NEW_RG_NO AND CANCER_IMMUNOTHERAPY_IND = 'N' AND MOLECULE_TYPE_ID = C_MOLECULE_TYPE_ID AND PHARMACOLOGICAL_TYPE_ID = C_PHARMACOLOGICAL_TYPE_ID;\n        INSERT INTO THEME_MOLECULE_MAP TMMAP( TMMAP.THEME_NO, TMMAP.MOLECULE_ID, TMMAP.MOLECULE_SEQ_NO, TMMAP.VALID_IND ) VALUES ( :NEW.THEME_NO, V_MOLECULE_ID, 1, 'Y' );\n      END IF;\n    END IF;\n    CASE\n      WHEN  THEN\n        IF (SUBSTRING(:NEW.THEME_NO, 1, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 2, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 3, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 4, 1) NOT BETWEEN 0 AND 9) THEN\n          RAISE EXCEPTION 'This is not a valid Theme No';\n        END IF;\n      WHEN  THEN\n        IF (SUBSTRING(:NEW.THEME_NO, 1, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 2, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 3, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 4, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 5, 1) NOT BETWEEN 0 AND 9) THEN\n          RAISE EXCEPTION 'This is not a valid Theme No';\n        END IF;\n      ELSE\n        RAISE EXCEPTION 'This is not a valid Theme No';\n    END CASE;\n    SELECT COUNT(T.THEME_NO) INTO V_COUNTER FROM ( SELECT THEME_NO FROM V_THEMES UNION ALL SELECT THEME_NO FROM GMD.THEMES_ARCHIVE )                  T WHERE T.THEME_NO = :NEW.THEME_NO;\n    IF (V_COUNTER > 0) THEN\n      RAISE EXCEPTION 'This Theme No already exists';\n    END IF;\n    IF (:NEW.OFFICIAL_IND = 'N') THEN\n      RAISE EXCEPTION 'New Themes can only be inserted by Official Changes';\n    END IF;\n    IF (UPPER(:NEW.PORTF_PROJ_CD) = 'N') THEN\n      IF (:NEW.THEME_DESC IS NULL OR LENGTH(:NEW.THEME_DESC) = 0) THEN\n        RAISE EXCEPTION 'If Pharma Rx Portfolio Project is set to \"No\", then the Theme Description must be filled';\n      END IF;\n    END IF;\n    IF (UPPER(:NEW.PORTF_PROJ_CD) = 'Y') THEN\n      IF (LENGTH(V_DESCRIPTION) > 90) THEN\n        RAISE EXCEPTION 'The automatically generated Theme Description is too long';\n      END IF;\n    ELSE\n    END IF;\n    SELECT COUNT(T.THEME_NO) INTO V_COUNTER FROM V_THEMES T WHERE T.THEME_DESC = V_DESCRIPTION;\n    IF (V_COUNTER > 0) THEN\n      RAISE EXCEPTION 'This Theme Description already exists';\n    END IF;\n    INSERT INTO GMD.THEMES( THEME_NO, REGISTRAT_DATE, ODG_NO, RESGRP_CD, RESLIN_CD, THEME_DESC, SHORT_NAME, STATUS_CD, DBA_CD, IN_PREP_IND, PROD_SHORT_CD, TRADEMARK_NO, BIO_ACTIVITY, APPLICANT, CONTACT, REGISTRAR, LINE_EXT_INFO, PORTF_PROJ_CD, CO_DEV_PRTNR, TECHNOLOGY_PRTNR, OFFICIAL_IND, CO_MAR_PRTNR, VALID_TO, PORTF_DA_GROUP_ID, MANUAL_SHORT_DESC ) VALUES ( :NEW.THEME_NO, V_D_REGISTRAT_DATE, V_ODG_NO, V_RESGRP_CD, V_RESLIN_CD, V_DESCRIPTION, V_SHORT_NAME, V_STATUS_CD, V_DBA_CD, :NEW.IN_PREP_IND, :NEW.PROD_SHORT_CD, :NEW.TRADEMARK_NO, :NEW.BIO_ACTIVITY, :NEW.APPLICANT, :NEW.CONTACT, TXO_UTIL.GET_USERID, :NEW.LINE_EXT_INFO, V_PORTF_PROJ_CD, :NEW.CO_DEV_PRTNR, :NEW.TECHNOLOGY_PRTNR, :NEW.OFFICIAL_IND, :NEW.CO_MAR_PRTNR, V_VALID_TO, :NEW.PORTF_DA_GROUP_ID, :NEW.MANUAL_SHORT_DESC );\n    IF (:OLD.MOLECULE_ID IS NULL AND :NEW.MOLECULE_ID IS NOT NULL) THEN\n      INSERT INTO MDM_V_THEME_MOLECULE_MAP_MTN A( A.THEME_NO, A.MOLECULE_ID, A.MOLECULE_SEQ_NO, A.VALID_IND ) VALUES ( :NEW.THEME_NO, V_MOLECULE_ID, 1, 'Y' );\n    END IF;\n  END IF;\n  IF ( OR ) THEN\n    IF (:NEW.PROPOSAL_ID IS NOT NULL AND :OLD.PROPOSAL_ID IS NULL) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID AND PROPOSAL_STATUS_CD = 'E';\n      IF (V_EVOLVED_NMP_CNT = 0) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'E', EVOLVED_THEME_NO = :NEW.THEME_NO, PROPOSAL_NAME = V_SHORT_NAME, REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID;\n      END IF;\n    ELSE\n      IF (:NEW.PROPOSAL_ID IS NULL AND :OLD.PROPOSAL_ID IS NOT NULL) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'A', EVOLVED_THEME_NO = NULL WHERE PROPOSAL_ID = :OLD.PROPOSAL_ID;\n      ELSE\n        IF (:NEW.PROPOSAL_ID IS NOT NULL AND :OLD.PROPOSAL_ID IS NOT NULL AND :NEW.PROPOSAL_ID <> :OLD.PROPOSAL_ID) THEN\n          UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'A', EVOLVED_THEME_NO = NULL WHERE PROPOSAL_ID = :OLD.PROPOSAL_ID;\n          UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'E', EVOLVED_THEME_NO = :NEW.THEME_NO, PROPOSAL_NAME = V_SHORT_NAME, REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID;\n        END IF;\n      END IF;\n    END IF;\n    IF (COALESCE(:NEW.PROPOSAL_ID, 0) = COALESCE(:OLD.PROPOSAL_ID, 0) AND COALESCE(:OLD.SHORT_NAME, '-') <> COALESCE(V_SHORT_NAME, '-')) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN NMP WHERE NMP.EVOLVED_THEME_NO =:NEW.THEME_NO AND NMP.PROPOSAL_STATUS_CD = 'E';\n      IF (V_EVOLVED_NMP_CNT > 0) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN NMP SET NMP.PROPOSAL_NAME = V_SHORT_NAME, NMP.REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE NMP.EVOLVED_THEME_NO =:NEW.THEME_NO AND NMP.PROPOSAL_STATUS_CD = 'E';\n      END IF;\n    END IF;\n  END IF;\n  IF ( AND :NEW.THEME_NO IS NOT NULL AND GMD_UTIL_THEMES.GET_THEMES_RANGE_AUTOMATIC_NMP(:NEW.THEME_NO) = 'Y') THEN\n    IF (:NEW.PROPOSAL_ID IS NOT NULL) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID AND PROPOSAL_NAME = V_SHORT_NAME AND PROPOSAL_STATUS_CD = 'E';\n    END IF;\n    IF (:NEW.PROPOSAL_ID IS NULL OR (:NEW.PROPOSAL_ID IS NOT NULL AND V_EVOLVED_NMP_CNT = 0)) THEN\n      IF (:NEW.MOLECULE_ID IS NOT NULL) THEN\n        BEGIN\n          SELECT PHARMACOLOGICAL_TYPE_ID, MOLECULE_TYPE_ID INTO V_PHARMACOLOGICAL_TYPE_ID, V_MOLECULE_TYPE_ID FROM V_THEME_MOLECULES M WHERE MOLECULE_ID = :NEW.MOLECULE_ID AND M.VALID_IND = 'Y';\n          EXCEPTION\n            WHEN NO_DATA_FOUND THEN\n              RAISE EXCEPTION 'This is not a valid Molecule ID';\n        END;\n      END IF;\n      INSERT INTO MDM_V_NEW_MEDICINE_PROPOSALS_MTN ( PROPOSAL_STATUS_CD, EVOLVED_THEME_NO, PROPOSAL_NAME, PHARMACOLOGICAL_TYPE_ID, MOLECULE_TYPE_ID, REASON_FOR_CHANGE ) VALUES ( 'E', :NEW.THEME_NO, V_SHORT_NAME, COALESCE(V_PHARMACOLOGICAL_TYPE_ID, C_PHARMACOLOGICAL_TYPE_ID), COALESCE(V_MOLECULE_TYPE_ID, C_MOLECULE_TYPE_ID), '** Automatic creation of nmp for early development themes **' );\n    END IF;\n  END IF;\n  EXCEPTION\n    WHEN ADMIN_UPDATE_ONLY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN IN_PREP_NOT_PORTF_PROJ THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN IN_PREP_NOT_CLOSED THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INVALID_MOLECULE_ID THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN SEC_MOL_LIST_NOT_EMPTY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INVALID_THEME_NO THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DELETE_NO_MORE_POSSIBLE THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_NO_ONLY_INSERT THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DESCRIPTION_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_PROPOSAL_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_ALT_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_NO_CANNOT_BE_INSERTED THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN ONLYONEOFFICIALCHANGEPERDAY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INSERTSMUSTBEOFFICIAL THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEMEDESCRIPTIONMANDATORY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_NOT_UNIQUE THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN PORTF_PROJ_MOL_CRE_ERR THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DEBUGGING THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\nEND;\nEND $$;"
        }
    ],
    "on_delete": [
        {
            "type": "sql",
            "sql": "DO $$\nDECLARE\n  V_COUNTER integer;\n  V_CODE varchar(2);\n  V_ODG_NO varchar(2);\n  V_RESGRP_CD varchar(2);\n  V_RESLIN_CD varchar(2);\n  V_STATUS_CD varchar(1);\n  V_DBA_CD integer;\n  V_PORTF_PROJ_CD varchar(1);\n  V_DESCRIPTION varchar(500);\n  V_RESLIN_DESC varchar(60);\n  V_THEME_DESC_LENGTH integer;\n  V_D_REGISTRAT_DATE date;\n  V_D_INS_DATE date;\n  V_FUTURE_REGISTRAT date;\n  V_VALID_TO date;\n  V_USERID varchar(30);\n  V_IS_ADMIN_CNT integer := 0;\n  V_SEC_MOL_CNT integer := 0;\n  V_MOLECULE_ID varchar(5);\n  V_MOLECULE_RG_NO varchar(20);\n  V_MOLEC_IN_LIC_PRTNR varchar(15);\n  V_NEW_RG_NO TEXT;\n  V_COMPARATOR_IND TEXT;\n  V_THEME_DESC_PROPOSAL TEXT;\n  V_SHORT_NAME varchar(30);\n  V_EVOLVED_NMP_CNT integer;\n  V_TRADEMARK_NO TEXT;\n  V_MOLECULE_TYPE_ID TEXT;\n  V_PHARMACOLOGICAL_TYPE_ID TEXT;\n  C_MOLECULE_TYPE_ID CONSTANT TEXT := 99;\n  C_PHARMACOLOGICAL_TYPE_ID CONSTANT TEXT := 19;\n  INVALID_THEME_NO EXCEPTION;\n  DELETE_NO_MORE_POSSIBLE EXCEPTION;\n  THEME_NO_ONLY_INSERT EXCEPTION;\n  DESCRIPTION_TOO_LONG EXCEPTION;\n  THEME_DESC_PROPOSAL_TOO_LONG EXCEPTION;\n  THEME_DESC_ALT_TOO_LONG EXCEPTION;\n  THEME_NO_CANNOT_BE_INSERTED EXCEPTION;\n  ONLYONEOFFICIALCHANGEPERDAY EXCEPTION;\n  INSERTSMUSTBEOFFICIAL EXCEPTION;\n  THEMEDESCRIPTIONMANDATORY EXCEPTION;\n  THEME_DESC_NOT_UNIQUE EXCEPTION;\n  IN_PREP_NOT_PORTF_PROJ EXCEPTION;\n  IN_PREP_NOT_CLOSED EXCEPTION;\n  INVALID_MOLECULE_ID EXCEPTION;\n  SEC_MOL_LIST_NOT_EMPTY EXCEPTION;\n  ADMIN_UPDATE_ONLY EXCEPTION;\n  PORTF_PROJ_MOL_CRE_ERR EXCEPTION;\n  DEBUGGING EXCEPTION;\nBEGIN\n  SELECT COALESCE(TXO_SECURITY.GET_USERID, current_user) INTO V_USERID ;\n  SELECT COUNT(*) INTO V_IS_ADMIN_CNT FROM TXO_USERS_ROLES_MAP WHERE ROLE_ID IN (315) AND USERID = V_USERID;\n  SELECT NEW_RG_NO INTO V_NEW_RG_NO FROM ( SELECT NEW_RG_NO FROM ( SELECT ROWNUM AS NEW_RG_NO  /* CONNECT BY - replace with recursive CTE */ 1 = 1 AND ROWNUM <= 6999 ) WHERE NEW_RG_NO > 5999 MINUS SELECT CAST(RG_NO) FROM V_THEME_MOLECULES ) WHERE ROWNUM = 1;\n  IF (:NEW.IN_PREP_IND = 'Y') THEN\n    IF (:NEW.PORTF_PROJ_CD <> 'Y') THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: In-prep theme must be portfolio project';\n    END IF;\n    IF (:NEW.STATUS_DESC <> 'CLOSED' AND V_IS_ADMIN_CNT = 0) THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: In-prep status validation failed';\n    END IF;\n    IF (:NEW.MOLECULE_ID IS NULL) THEN\n      PERFORM txo_util.set_warning();\n    END IF;\n  END IF;\n  IF (:NEW.MOLECULE_ID IS NOT NULL) THEN\n    BEGIN\n      SELECT RG_NO, M.COMPARATOR_IND INTO V_MOLECULE_RG_NO, V_COMPARATOR_IND FROM V_THEME_MOLECULES M WHERE MOLECULE_ID = :NEW.MOLECULE_ID AND M.VALID_IND = 'Y';\n      EXCEPTION\n        WHEN NO_DATA_FOUND THEN\n          RAISE EXCEPTION 'This is not a valid Molecule ID';\n    END;\n    IF (V_MOLECULE_RG_NO IS NULL) THEN\n      IF (V_COMPARATOR_IND = 'Y') THEN\n        NULL;\n      ELSE\n        UPDATE V_THEME_MOLECULES SET RG_NO = V_NEW_RG_NO WHERE MOLECULE_ID = :NEW.MOLECULE_ID;\n      END IF;\n    END IF;\n  END IF;\n  IF (:NEW.STATUS_DESC IS NOT NULL) THEN\n    SELECT STATUS_CD INTO V_STATUS_CD FROM MDM_V_THEME_STATUS WHERE STATE_DESC = :NEW.STATUS_DESC;\n  ELSE\n  END IF;\n  IF (:NEW.DBA_DESC_CONCAT IS NOT NULL) THEN\n    SELECT DBA_CD INTO V_DBA_CD FROM MDM_V_DISEASE_BIOLOGY_AREAS WHERE DBA_SHORT_DESC || ' - ' || DBA_DESC = :NEW.DBA_DESC_CONCAT;\n  ELSE\n  END IF;\n  IF (:NEW.OFFICIAL_IND = 'N') THEN\n  ELSE\n  END IF;\n  IF (:NEW.MANUAL_SHORT_DESC IS NULL AND LENGTH(V_THEME_DESC_PROPOSAL) > 30) THEN\n    RAISE EXCEPTION 'The automatically generated Short Description Proposal is too long';\n  END IF;\n  IF TRUE THEN\n    IF (:NEW.IN_PREP_IND = 'N' AND V_IS_ADMIN_CNT = 0) THEN\n      RAISE EXCEPTION 'MDM_V_THEMES_IOF: Admin access required for this operation';\n    END IF;\n    IF (:NEW.PORTF_PROJ_CD = 'Y' AND :NEW.MOLECULE_ID IS NULL) THEN\n      IF (COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL) IS NULL) THEN\n        RAISE EXCEPTION 'MDM_V_THEMES_IOF: Portfolio project molecule creation error';\n      ELSE\n        INSERT INTO MDM_V_THEME_MOLECULES_MTN( MOLECULE_DESC, VALID_IND, RG_NO, CANCER_IMMUNOTHERAPY_IND, MOLECULE_TYPE_ID, PHARMACOLOGICAL_TYPE_ID ) VALUES ( COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL), 'Y', V_NEW_RG_NO, 'N', C_MOLECULE_TYPE_ID, C_PHARMACOLOGICAL_TYPE_ID );\n        SELECT MOLECULE_ID INTO V_MOLECULE_ID FROM V_THEME_MOLECULES WHERE MOLECULE_DESC = COALESCE(:NEW.MANUAL_SHORT_DESC, :NEW.THEME_DESC_PROPOSAL) AND VALID_IND = 'Y' AND RG_NO = V_NEW_RG_NO AND CANCER_IMMUNOTHERAPY_IND = 'N' AND MOLECULE_TYPE_ID = C_MOLECULE_TYPE_ID AND PHARMACOLOGICAL_TYPE_ID = C_PHARMACOLOGICAL_TYPE_ID;\n        INSERT INTO THEME_MOLECULE_MAP TMMAP( TMMAP.THEME_NO, TMMAP.MOLECULE_ID, TMMAP.MOLECULE_SEQ_NO, TMMAP.VALID_IND ) VALUES ( :NEW.THEME_NO, V_MOLECULE_ID, 1, 'Y' );\n      END IF;\n    END IF;\n    CASE\n      WHEN  THEN\n        IF (SUBSTRING(:NEW.THEME_NO, 1, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 2, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 3, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 4, 1) NOT BETWEEN 0 AND 9) THEN\n          RAISE EXCEPTION 'This is not a valid Theme No';\n        END IF;\n      WHEN  THEN\n        IF (SUBSTRING(:NEW.THEME_NO, 1, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 2, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 3, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 4, 1) NOT BETWEEN 0 AND 9 OR SUBSTRING(:NEW.THEME_NO, 5, 1) NOT BETWEEN 0 AND 9) THEN\n          RAISE EXCEPTION 'This is not a valid Theme No';\n        END IF;\n      ELSE\n        RAISE EXCEPTION 'This is not a valid Theme No';\n    END CASE;\n    SELECT COUNT(T.THEME_NO) INTO V_COUNTER FROM ( SELECT THEME_NO FROM V_THEMES UNION ALL SELECT THEME_NO FROM GMD.THEMES_ARCHIVE )                  T WHERE T.THEME_NO = :NEW.THEME_NO;\n    IF (V_COUNTER > 0) THEN\n      RAISE EXCEPTION 'This Theme No already exists';\n    END IF;\n    IF (:NEW.OFFICIAL_IND = 'N') THEN\n      RAISE EXCEPTION 'New Themes can only be inserted by Official Changes';\n    END IF;\n    IF (UPPER(:NEW.PORTF_PROJ_CD) = 'N') THEN\n      IF (:NEW.THEME_DESC IS NULL OR LENGTH(:NEW.THEME_DESC) = 0) THEN\n        RAISE EXCEPTION 'If Pharma Rx Portfolio Project is set to \"No\", then the Theme Description must be filled';\n      END IF;\n    END IF;\n    IF (UPPER(:NEW.PORTF_PROJ_CD) = 'Y') THEN\n      IF (LENGTH(V_DESCRIPTION) > 90) THEN\n        RAISE EXCEPTION 'The automatically generated Theme Description is too long';\n      END IF;\n    ELSE\n    END IF;\n    SELECT COUNT(T.THEME_NO) INTO V_COUNTER FROM V_THEMES T WHERE T.THEME_DESC = V_DESCRIPTION;\n    IF (V_COUNTER > 0) THEN\n      RAISE EXCEPTION 'This Theme Description already exists';\n    END IF;\n    INSERT INTO GMD.THEMES( THEME_NO, REGISTRAT_DATE, ODG_NO, RESGRP_CD, RESLIN_CD, THEME_DESC, SHORT_NAME, STATUS_CD, DBA_CD, IN_PREP_IND, PROD_SHORT_CD, TRADEMARK_NO, BIO_ACTIVITY, APPLICANT, CONTACT, REGISTRAR, LINE_EXT_INFO, PORTF_PROJ_CD, CO_DEV_PRTNR, TECHNOLOGY_PRTNR, OFFICIAL_IND, CO_MAR_PRTNR, VALID_TO, PORTF_DA_GROUP_ID, MANUAL_SHORT_DESC ) VALUES ( :NEW.THEME_NO, V_D_REGISTRAT_DATE, V_ODG_NO, V_RESGRP_CD, V_RESLIN_CD, V_DESCRIPTION, V_SHORT_NAME, V_STATUS_CD, V_DBA_CD, :NEW.IN_PREP_IND, :NEW.PROD_SHORT_CD, :NEW.TRADEMARK_NO, :NEW.BIO_ACTIVITY, :NEW.APPLICANT, :NEW.CONTACT, TXO_UTIL.GET_USERID, :NEW.LINE_EXT_INFO, V_PORTF_PROJ_CD, :NEW.CO_DEV_PRTNR, :NEW.TECHNOLOGY_PRTNR, :NEW.OFFICIAL_IND, :NEW.CO_MAR_PRTNR, V_VALID_TO, :NEW.PORTF_DA_GROUP_ID, :NEW.MANUAL_SHORT_DESC );\n    IF (:OLD.MOLECULE_ID IS NULL AND :NEW.MOLECULE_ID IS NOT NULL) THEN\n      INSERT INTO MDM_V_THEME_MOLECULE_MAP_MTN A( A.THEME_NO, A.MOLECULE_ID, A.MOLECULE_SEQ_NO, A.VALID_IND ) VALUES ( :NEW.THEME_NO, V_MOLECULE_ID, 1, 'Y' );\n    END IF;\n  END IF;\n  IF ( OR ) THEN\n    IF (:NEW.PROPOSAL_ID IS NOT NULL AND :OLD.PROPOSAL_ID IS NULL) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID AND PROPOSAL_STATUS_CD = 'E';\n      IF (V_EVOLVED_NMP_CNT = 0) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'E', EVOLVED_THEME_NO = :NEW.THEME_NO, PROPOSAL_NAME = V_SHORT_NAME, REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID;\n      END IF;\n    ELSE\n      IF (:NEW.PROPOSAL_ID IS NULL AND :OLD.PROPOSAL_ID IS NOT NULL) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'A', EVOLVED_THEME_NO = NULL WHERE PROPOSAL_ID = :OLD.PROPOSAL_ID;\n      ELSE\n        IF (:NEW.PROPOSAL_ID IS NOT NULL AND :OLD.PROPOSAL_ID IS NOT NULL AND :NEW.PROPOSAL_ID <> :OLD.PROPOSAL_ID) THEN\n          UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'A', EVOLVED_THEME_NO = NULL WHERE PROPOSAL_ID = :OLD.PROPOSAL_ID;\n          UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN SET PROPOSAL_STATUS_CD = 'E', EVOLVED_THEME_NO = :NEW.THEME_NO, PROPOSAL_NAME = V_SHORT_NAME, REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID;\n        END IF;\n      END IF;\n    END IF;\n    IF (COALESCE(:NEW.PROPOSAL_ID, 0) = COALESCE(:OLD.PROPOSAL_ID, 0) AND COALESCE(:OLD.SHORT_NAME, '-') <> COALESCE(V_SHORT_NAME, '-')) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN NMP WHERE NMP.EVOLVED_THEME_NO =:NEW.THEME_NO AND NMP.PROPOSAL_STATUS_CD = 'E';\n      IF (V_EVOLVED_NMP_CNT > 0) THEN\n        UPDATE MDM_V_NEW_MEDICINE_PROPOSALS_MTN NMP SET NMP.PROPOSAL_NAME = V_SHORT_NAME, NMP.REASON_FOR_CHANGE = '** Automatic update of proposal_name after short_name change in evolved theme **' WHERE NMP.EVOLVED_THEME_NO =:NEW.THEME_NO AND NMP.PROPOSAL_STATUS_CD = 'E';\n      END IF;\n    END IF;\n  END IF;\n  IF ( AND :NEW.THEME_NO IS NOT NULL AND GMD_UTIL_THEMES.GET_THEMES_RANGE_AUTOMATIC_NMP(:NEW.THEME_NO) = 'Y') THEN\n    IF (:NEW.PROPOSAL_ID IS NOT NULL) THEN\n      SELECT COUNT(*) INTO V_EVOLVED_NMP_CNT FROM MDM_V_NEW_MEDICINE_PROPOSALS_MTN WHERE PROPOSAL_ID = :NEW.PROPOSAL_ID AND PROPOSAL_NAME = V_SHORT_NAME AND PROPOSAL_STATUS_CD = 'E';\n    END IF;\n    IF (:NEW.PROPOSAL_ID IS NULL OR (:NEW.PROPOSAL_ID IS NOT NULL AND V_EVOLVED_NMP_CNT = 0)) THEN\n      IF (:NEW.MOLECULE_ID IS NOT NULL) THEN\n        BEGIN\n          SELECT PHARMACOLOGICAL_TYPE_ID, MOLECULE_TYPE_ID INTO V_PHARMACOLOGICAL_TYPE_ID, V_MOLECULE_TYPE_ID FROM V_THEME_MOLECULES M WHERE MOLECULE_ID = :NEW.MOLECULE_ID AND M.VALID_IND = 'Y';\n          EXCEPTION\n            WHEN NO_DATA_FOUND THEN\n              RAISE EXCEPTION 'This is not a valid Molecule ID';\n        END;\n      END IF;\n      INSERT INTO MDM_V_NEW_MEDICINE_PROPOSALS_MTN ( PROPOSAL_STATUS_CD, EVOLVED_THEME_NO, PROPOSAL_NAME, PHARMACOLOGICAL_TYPE_ID, MOLECULE_TYPE_ID, REASON_FOR_CHANGE ) VALUES ( 'E', :NEW.THEME_NO, V_SHORT_NAME, COALESCE(V_PHARMACOLOGICAL_TYPE_ID, C_PHARMACOLOGICAL_TYPE_ID), COALESCE(V_MOLECULE_TYPE_ID, C_MOLECULE_TYPE_ID), '** Automatic creation of nmp for early development themes **' );\n    END IF;\n  END IF;\n  EXCEPTION\n    WHEN ADMIN_UPDATE_ONLY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN IN_PREP_NOT_PORTF_PROJ THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN IN_PREP_NOT_CLOSED THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INVALID_MOLECULE_ID THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN SEC_MOL_LIST_NOT_EMPTY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INVALID_THEME_NO THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DELETE_NO_MORE_POSSIBLE THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_NO_ONLY_INSERT THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DESCRIPTION_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_PROPOSAL_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_ALT_TOO_LONG THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_NO_CANNOT_BE_INSERTED THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN ONLYONEOFFICIALCHANGEPERDAY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN INSERTSMUSTBEOFFICIAL THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEMEDESCRIPTIONMANDATORY THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN THEME_DESC_NOT_UNIQUE THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN PORTF_PROJ_MOL_CRE_ERR THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\n    WHEN DEBUGGING THEN\n      RAISE_APPLICATION_ERROR(-20000, '');\nEND;\nEND $$;"
        }
    ]
}
{
    "on_insert": [
        {
            "type": "sql",
            "sql": "DO $$ DECLARE CNTR integer; V_USERID VARCHAR2(100); V_REPORTING_ENTITY_CD CFG_V_REPORTING_ENTITIES.REPORTING_ENTITY_CD%TYPE; V_LEGAL_COMPANY_CD CFG_V_COMPANIES.LEGAL_COMPANY_CD%TYPE; V_OLD_LEGAL_COMPANY_CD CFG_V_COMPANIES.LEGAL_COMPANY_CD%TYPE := 'NVL(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD)'; V_REP_CBC_FLAG CFG_V_REPORTING_ENTITIES.CBC_FLAG%TYPE; V_ADDR_VALID_FROM_DATE CFG.CFG_V_COMPANY_ADDRESSES.VALID_FROM%TYPE; V_COUNTRY_CD CFG.CFG_V_COMPANY_ADDRESSES.COUNTRY_CD%TYPE; V_COMPANY_CODES_LIST VARCHAR2(200); BEGIN V_USERID := TXO_UTIL.GET_USERID; IF TRUE THEN CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG_V_COMPANIES WHERE COMPANY_CD = :NEW.COMPANY_CD; IF CNTR > 0 THEN RAISE EXCEPTION ERR_INS; END IF; END IF; IF TRUE THEN IF :NEW.COMPANY_TYPE_CD IN ('L', 'A') AND :NEW.LEGAL_COMPANY_CD IS NULL THEN V_LEGAL_COMPANY_CD := :NEW.COMPANY_CD; END IF; CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG_V_COMPANIES WHERE COMPANY_TYPE_CD IN ( 'L') AND VALID_IND = 'Y' AND COMPANY_CD = V_LEGAL_COMPANY_CD; IF CNTR = 0 AND (COALESCE(:NEW.COMPANY_TYPE_CD, :OLD.COMPANY_TYPE_CD) NOT IN ('D', 'A', 'L') OR (:NEW.COMPANY_TYPE_CD = 'D' AND :NEW.CBC_GBE_SCOPE = 'Y' AND V_LEGAL_COMPANY_CD <> :NEW.COMPANY_CD)) THEN RAISE EXCEPTION INVALID_LEGAL_COMP; END IF; MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_COMPANY_TYPE_CD => :NEW.COMPANY_TYPE_CD, I_MULTISEL_COMPANY_PURPOSE => :NEW.MULTISEL_COMPANY_PURPOSE, I_LEGAL_COMPANY_CD => V_LEGAL_COMPANY_CD, I_OFFICIAL_NAME => :NEW.OFFICIAL_NAME, I_SHORT_NAME => :NEW.SHORT_NAME, I_DISCLOSURE_NAME => :NEW.DISCLOSURE_NAME, I_FUNCTIONAL_CURRENCY_CD => :NEW.FUNCTIONAL_CURRENCY_CD, I_STATUTORY_CURRENCY_CD => :NEW.STATUTORY_CURRENCY_CD, I_URL => :NEW.URL, I_PHONEBOOK_URL => :NEW.PHONEBOOK_URL, I_EMERGENCY_PHONE_NO => :NEW.EMERGENCY_PHONE_NO, I_GENERAL_PHONE_NO => :NEW.GENERAL_PHONE_NO, I_GENERAL_FAX_NO => :NEW.GENERAL_FAX_NO, I_ANNUAL_REPORT_IND => :NEW.ANNUAL_REPORT_IND, I_FATCA_CD => :NEW.FATCA_CD, I_PHARMA_NUMBER_RANGE => :NEW.PHARMA_NUMBER_RANGE, I_LIQUIDATION_DATE => :NEW.LIQUIDATION_DATE, I_SAPINST_NO => :NEW.SAPINST_NO, I_SAP_COMPANY_CODE_NO => :NEW.SAP_COMPANY_CODE_NO, I_SAP_GO_LIVE_DATE => :NEW.SAP_GO_LIVE_DATE, I_SAP_GROUP_CODE => :NEW.SAP_GROUP_CODE, I_SAP_LOCAL_COA => :NEW.SAP_LOCAL_COA, I_SAP_CONTROLLING_AREA => :NEW.SAP_CONTROLLING_AREA, I_TOP_SYSTEM_IND => :NEW.TOP_SYSTEM_IND, I_TOP_GO_LIVE_DATE => :NEW.TOP_GO_LIVE_DATE, I_TOP_REMARKS => :NEW.TOP_REMARKS, I_LEGAL_REMARKS => :NEW.LEGAL_REMARKS, I_REMARKS => :NEW.REMARKS, I_LOCAL_STATUTORY_ACC => :NEW.LOCAL_STATUTORY_ACC, I_ICFR_COMPANY_LAYER => :NEW.ICFR_COMPANY_LAYER, I_TRADING_PARTNER => :NEW.TRADING_PARTNER, I_S4_ENTITY_ID => :NEW.S4_ENTITY_ID, I_RCA_DISPLAY_FLAG => :NEW.RCA_DISPLAY_FLAG, I_CBC_GBE_SCOPE => :NEW.CBC_GBE_SCOPE, I_WEB_DISPLAY_IND => :NEW.WEB_DISPLAY_IND, I_HEADCOUNT_IND => :NEW.HEADCOUNT_IND, I_VALID_IND => :NEW.VALID_IND, I_CORE_REMARKS => :NEW.CORE_REMARKS, I_REVIEW_USERID => :NEW.REVIEW_USERID, I_REVIEW_EXP_DATE => :NEW.REVIEW_EXP_DATE, I_REQUESTER_USERID => :NEW.REQUESTER_USERID, I_REQUEST_DATE => :NEW.REQUEST_DATE, I_CHANGE_USER => V_USERID); CASE WHEN COALESCE (:OLD.REPORTING_ENTITY_CD, '-') != COALESCE (:NEW.REPORTING_ENTITY_CD, '-') OR COALESCE (TO_TIMESTAMP (:OLD.VALID_FROM_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) != COALESCE (TO_TIMESTAMP (:NEW.VALID_FROM_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) OR COALESCE (TO_TIMESTAMP (:OLD.VALID_TO_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) != COALESCE (TO_TIMESTAMP (:NEW.VALID_TO_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) THEN V_REPORTING_ENTITY_CD := :NEW.REPORTING_ENTITY_CD; CASE WHEN ( :NEW.VALID_FROM_DATE IS NULL OR :NEW.VALID_FROM_DATE IS NULL) THEN RAISE EXCEPTION ERR_VALID_FROM_DATE; ELSE NULL; END CASE; MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_REPORTING_ENTITY_CD => :NEW.REPORTING_ENTITY_CD, I_VALID_FROM_DATE => :NEW.VALID_FROM_DATE, I_VALID_TO_DATE => :NEW.VALID_TO_DATE, I_CHANGE_USER => V_USERID); ELSE NULL; END CASE; IF COALESCE(:NEW.VALID_IND, 'Y') = 'N' AND COALESCE(:OLD.VALID_IND, 'N') = 'Y' THEN CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG_V_COMPANIES WHERE LEGAL_COMPANY_CD = :NEW.COMPANY_CD AND COMPANY_CD <> :NEW.COMPANY_CD AND VALID_IND = 'Y'; IF CNTR > 0 THEN SELECT STRING_AGG(DISTINCT COMPANY_CD, ', ') WITHIN GROUP (ORDER BY COMPANY_CD) INTO V_COMPANY_CODES_LIST FROM CFG_V_COMPANIES WHERE LEGAL_COMPANY_CD = :NEW.COMPANY_CD AND COMPANY_CD <> :NEW.COMPANY_CD AND VALID_IND = 'Y'; RAISE EXCEPTION CPY_IN_USE; END IF; UPDATE CFG.CFG_COMPANY_ADDRESSES SET VALID_TO = DATE_TRUNC ( CURRENT_TIMESTAMP ) - 1 WHERE COMPANY_CD = :NEW.COMPANY_CD AND ( VALID_TO > DATE_TRUNC(CURRENT_TIMESTAMP) OR VALID_TO IS NULL); END IF; IF :OLD.COMPANY_TYPE_CD IN ('L', 'B') AND :NEW.COMPANY_TYPE_CD = 'D' THEN UPDATE CFG.CFG_COMPANY_ADDRESSES SET VALID_TO = DATE_TRUNC ( CURRENT_TIMESTAMP ) - 1 WHERE COMPANY_CD = :NEW.COMPANY_CD AND ADDRESS_TYPE_CD NOT IN ('P', 'RES', 'L', 'INC') AND ( VALID_TO > DATE_TRUNC(CURRENT_TIMESTAMP) OR VALID_TO IS NULL); END IF; IF :NEW.CBC_GBE_SCOPE = 'Y' AND :NEW.VALID_IND = 'N' THEN RAISE EXCEPTION ERR_CPY_STILL_IN_SCOPE; END IF; IF :NEW.VALID_IND = 'N' AND COALESCE(:NEW.REPORTING_ENTITY_CD, :OLD.REPORTING_ENTITY_CD) IS NOT NULL AND COALESCE(:NEW.VALID_TO_DATE, :OLD.VALID_TO_DATE) IS NULL THEN RAISE EXCEPTION ERR_CPY_STILL_IN_MFR; END IF; IF :NEW.COMPANY_TYPE_CD = 'A' AND :NEW.CBC_GBE_SCOPE = 'Y' THEN RAISE EXCEPTION ERR_ASSOC_ENT_NOT_ALLOWED_FOR_CBC; END IF; IF COALESCE(:NEW.COMPANY_TYPE_CD, :OLD.COMPANY_TYPE_CD) = 'L' OR COALESCE(:NEW.COMPANY_TYPE_CD, :NEW.COMPANY_TYPE_CD) = 'B' THEN V_REPORTING_ENTITY_CD := COALESCE (:NEW.COMPANY_CD, :OLD.COMPANY_CD); END IF; IF V_REPORTING_ENTITY_CD IS NOT NULL OR :NEW.COMPANY_TYPE_CD = 'D' THEN IF (:NEW.CBC_GBE_SCOPE = 'Y' AND COALESCE (:OLD.CBC_GBE_SCOPE, 'N') = 'N') OR (COALESCE(:NEW.CBC_GBE_SCOPE, :OLD.CBC_GBE_SCOPE) = 'Y' AND V_LEGAL_COMPANY_CD <> COALESCE(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD)) THEN SELECT CBC_FLAG INTO V_REP_CBC_FLAG FROM CFG_V_REPORTING_ENTITIES WHERE REPORTING_ENTITY_CD = V_LEGAL_COMPANY_CD; IF COALESCE (V_REP_CBC_FLAG, 'N') = 'N' THEN RAISE EXCEPTION RU_NOT_IN_CBC_SCOPE; END IF; CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG.CFG_V_COMPANY_ADDRESSES WHERE COMPANY_CD = V_REPORTING_ENTITY_CD AND ADDRESS_TYPE_CD = 'RES'; IF CNTR = 0 THEN RAISE EXCEPTION ERR_NO_ADR; END IF; SELECT VALID_FROM, COUNTRY_CD INTO V_ADDR_VALID_FROM_DATE, V_COUNTRY_CD FROM CFG.CFG_V_COMPANY_ADDRESSES WHERE COMPANY_CD = V_REPORTING_ENTITY_CD AND ADDRESS_TYPE_CD = 'RES'; IF V_LEGAL_COMPANY_CD <> COALESCE(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD) THEN V_ADDR_VALID_FROM_DATE := DATE_TRUNC(CURRENT_TIMESTAMP); END IF; MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_REPORTING_ENTITY_CD => V_REPORTING_ENTITY_CD, I_VALID_FROM_DATE => TRUNC (SYSDATE), I_VALID_TO_DATE => NULL, I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'CE', I_ACTION_TYPE => 'INSERT'); MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_REPORTING_ENTITY_CD => 'J-' || V_COUNTRY_CD, I_VALID_FROM_DATE => V_ADDR_VALID_FROM_DATE, I_VALID_TO_DATE => NULL, I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'JU', I_ACTION_TYPE => 'INSERT'); END IF; IF :NEW.CBC_GBE_SCOPE = 'N' AND COALESCE (:OLD.CBC_GBE_SCOPE, 'Y') = 'Y' THEN MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_VALID_FROM_DATE => NULL, I_VALID_TO_DATE => TRUNC (SYSDATE), I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'CE', I_ACTION_TYPE => 'UPDATE'); MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_VALID_FROM_DATE => NULL, I_VALID_TO_DATE => TRUNC (SYSDATE), I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'JU', I_ACTION_TYPE => 'UPDATE'); END IF; END IF; CASE WHEN (COALESCE (:OLD.OFFICIAL_NAME, '-') != COALESCE (:NEW.OFFICIAL_NAME, '-')) AND :OLD.OFFICIAL_NAME IS NOT NULL THEN MDMAPPL.MDM_UTIL_COMPANIES.MODIFYCOMPANYNAME(:NEW.COMPANY_CD, V_LEGAL_COMPANY_CD, :NEW.OFFICIAL_NAME, V_USERID); ELSE NULL; END CASE; END IF; END; $$ LANGUAGE plpgsql;"
        }
    ],
    "on_update": [
        {
            "type": "sql",
            "sql": "DO $$ DECLARE CNTR integer; V_USERID VARCHAR2(100); V_REPORTING_ENTITY_CD CFG_V_REPORTING_ENTITIES.REPORTING_ENTITY_CD%TYPE; V_LEGAL_COMPANY_CD CFG_V_COMPANIES.LEGAL_COMPANY_CD%TYPE; V_OLD_LEGAL_COMPANY_CD CFG_V_COMPANIES.LEGAL_COMPANY_CD%TYPE := 'NVL(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD)'; V_REP_CBC_FLAG CFG_V_REPORTING_ENTITIES.CBC_FLAG%TYPE; V_ADDR_VALID_FROM_DATE CFG.CFG_V_COMPANY_ADDRESSES.VALID_FROM%TYPE; V_COUNTRY_CD CFG.CFG_V_COMPANY_ADDRESSES.COUNTRY_CD%TYPE; V_COMPANY_CODES_LIST VARCHAR2(200); BEGIN V_USERID := TXO_UTIL.GET_USERID; IF :OLD.COMPANY_CD != :NEW.COMPANY_CD THEN RAISE EXCEPTION ERR_UPD; END IF; IF TRUE THEN IF :NEW.COMPANY_TYPE_CD IN ('L', 'A') AND :NEW.LEGAL_COMPANY_CD IS NULL THEN V_LEGAL_COMPANY_CD := :NEW.COMPANY_CD; END IF; CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG_V_COMPANIES WHERE COMPANY_TYPE_CD IN ( 'L') AND VALID_IND = 'Y' AND COMPANY_CD = V_LEGAL_COMPANY_CD; IF CNTR = 0 AND (COALESCE(:NEW.COMPANY_TYPE_CD, :OLD.COMPANY_TYPE_CD) NOT IN ('D', 'A', 'L') OR (:NEW.COMPANY_TYPE_CD = 'D' AND :NEW.CBC_GBE_SCOPE = 'Y' AND V_LEGAL_COMPANY_CD <> :NEW.COMPANY_CD)) THEN RAISE EXCEPTION INVALID_LEGAL_COMP; END IF; MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_COMPANY_TYPE_CD => :NEW.COMPANY_TYPE_CD, I_MULTISEL_COMPANY_PURPOSE => :NEW.MULTISEL_COMPANY_PURPOSE, I_LEGAL_COMPANY_CD => V_LEGAL_COMPANY_CD, I_OFFICIAL_NAME => :NEW.OFFICIAL_NAME, I_SHORT_NAME => :NEW.SHORT_NAME, I_DISCLOSURE_NAME => :NEW.DISCLOSURE_NAME, I_FUNCTIONAL_CURRENCY_CD => :NEW.FUNCTIONAL_CURRENCY_CD, I_STATUTORY_CURRENCY_CD => :NEW.STATUTORY_CURRENCY_CD, I_URL => :NEW.URL, I_PHONEBOOK_URL => :NEW.PHONEBOOK_URL, I_EMERGENCY_PHONE_NO => :NEW.EMERGENCY_PHONE_NO, I_GENERAL_PHONE_NO => :NEW.GENERAL_PHONE_NO, I_GENERAL_FAX_NO => :NEW.GENERAL_FAX_NO, I_ANNUAL_REPORT_IND => :NEW.ANNUAL_REPORT_IND, I_FATCA_CD => :NEW.FATCA_CD, I_PHARMA_NUMBER_RANGE => :NEW.PHARMA_NUMBER_RANGE, I_LIQUIDATION_DATE => :NEW.LIQUIDATION_DATE, I_SAPINST_NO => :NEW.SAPINST_NO, I_SAP_COMPANY_CODE_NO => :NEW.SAP_COMPANY_CODE_NO, I_SAP_GO_LIVE_DATE => :NEW.SAP_GO_LIVE_DATE, I_SAP_GROUP_CODE => :NEW.SAP_GROUP_CODE, I_SAP_LOCAL_COA => :NEW.SAP_LOCAL_COA, I_SAP_CONTROLLING_AREA => :NEW.SAP_CONTROLLING_AREA, I_TOP_SYSTEM_IND => :NEW.TOP_SYSTEM_IND, I_TOP_GO_LIVE_DATE => :NEW.TOP_GO_LIVE_DATE, I_TOP_REMARKS => :NEW.TOP_REMARKS, I_LEGAL_REMARKS => :NEW.LEGAL_REMARKS, I_REMARKS => :NEW.REMARKS, I_LOCAL_STATUTORY_ACC => :NEW.LOCAL_STATUTORY_ACC, I_ICFR_COMPANY_LAYER => :NEW.ICFR_COMPANY_LAYER, I_TRADING_PARTNER => :NEW.TRADING_PARTNER, I_S4_ENTITY_ID => :NEW.S4_ENTITY_ID, I_RCA_DISPLAY_FLAG => :NEW.RCA_DISPLAY_FLAG, I_CBC_GBE_SCOPE => :NEW.CBC_GBE_SCOPE, I_WEB_DISPLAY_IND => :NEW.WEB_DISPLAY_IND, I_HEADCOUNT_IND => :NEW.HEADCOUNT_IND, I_VALID_IND => :NEW.VALID_IND, I_CORE_REMARKS => :NEW.CORE_REMARKS, I_REVIEW_USERID => :NEW.REVIEW_USERID, I_REVIEW_EXP_DATE => :NEW.REVIEW_EXP_DATE, I_REQUESTER_USERID => :NEW.REQUESTER_USERID, I_REQUEST_DATE => :NEW.REQUEST_DATE, I_CHANGE_USER => V_USERID); CASE WHEN COALESCE (:OLD.REPORTING_ENTITY_CD, '-') != COALESCE (:NEW.REPORTING_ENTITY_CD, '-') OR COALESCE (TO_TIMESTAMP (:OLD.VALID_FROM_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) != COALESCE (TO_TIMESTAMP (:NEW.VALID_FROM_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) OR COALESCE (TO_TIMESTAMP (:OLD.VALID_TO_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) != COALESCE (TO_TIMESTAMP (:NEW.VALID_TO_DATE, 'DD-MM-YYYY'), CURRENT_TIMESTAMP + 100) THEN V_REPORTING_ENTITY_CD := :NEW.REPORTING_ENTITY_CD; CASE WHEN ( :NEW.VALID_FROM_DATE IS NULL OR :NEW.VALID_FROM_DATE IS NULL) THEN RAISE EXCEPTION ERR_VALID_FROM_DATE; ELSE NULL; END CASE; MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_REPORTING_ENTITY_CD => :NEW.REPORTING_ENTITY_CD, I_VALID_FROM_DATE => :NEW.VALID_FROM_DATE, I_VALID_TO_DATE => :NEW.VALID_TO_DATE, I_CHANGE_USER => V_USERID); ELSE NULL; END CASE; IF COALESCE(:NEW.VALID_IND, 'Y') = 'N' AND COALESCE(:OLD.VALID_IND, 'N') = 'Y' THEN CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG_V_COMPANIES WHERE LEGAL_COMPANY_CD = :NEW.COMPANY_CD AND COMPANY_CD <> :NEW.COMPANY_CD AND VALID_IND = 'Y'; IF CNTR > 0 THEN SELECT STRING_AGG(DISTINCT COMPANY_CD, ', ') WITHIN GROUP (ORDER BY COMPANY_CD) INTO V_COMPANY_CODES_LIST FROM CFG_V_COMPANIES WHERE LEGAL_COMPANY_CD = :NEW.COMPANY_CD AND COMPANY_CD <> :NEW.COMPANY_CD AND VALID_IND = 'Y'; RAISE EXCEPTION CPY_IN_USE; END IF; UPDATE CFG.CFG_COMPANY_ADDRESSES SET VALID_TO = DATE_TRUNC ( CURRENT_TIMESTAMP ) - 1 WHERE COMPANY_CD = :NEW.COMPANY_CD AND ( VALID_TO > DATE_TRUNC(CURRENT_TIMESTAMP) OR VALID_TO IS NULL); END IF; IF :OLD.COMPANY_TYPE_CD IN ('L', 'B') AND :NEW.COMPANY_TYPE_CD = 'D' THEN UPDATE CFG.CFG_COMPANY_ADDRESSES SET VALID_TO = DATE_TRUNC ( CURRENT_TIMESTAMP ) - 1 WHERE COMPANY_CD = :NEW.COMPANY_CD AND ADDRESS_TYPE_CD NOT IN ('P', 'RES', 'L', 'INC') AND ( VALID_TO > DATE_TRUNC(CURRENT_TIMESTAMP) OR VALID_TO IS NULL); END IF; IF :NEW.CBC_GBE_SCOPE = 'Y' AND :NEW.VALID_IND = 'N' THEN RAISE EXCEPTION ERR_CPY_STILL_IN_SCOPE; END IF; IF :NEW.VALID_IND = 'N' AND COALESCE(:NEW.REPORTING_ENTITY_CD, :OLD.REPORTING_ENTITY_CD) IS NOT NULL AND COALESCE(:NEW.VALID_TO_DATE, :OLD.VALID_TO_DATE) IS NULL THEN RAISE EXCEPTION ERR_CPY_STILL_IN_MFR; END IF; IF :NEW.COMPANY_TYPE_CD = 'A' AND :NEW.CBC_GBE_SCOPE = 'Y' THEN RAISE EXCEPTION ERR_ASSOC_ENT_NOT_ALLOWED_FOR_CBC; END IF; IF COALESCE(:NEW.COMPANY_TYPE_CD, :OLD.COMPANY_TYPE_CD) = 'L' OR COALESCE(:NEW.COMPANY_TYPE_CD, :NEW.COMPANY_TYPE_CD) = 'B' THEN V_REPORTING_ENTITY_CD := COALESCE (:NEW.COMPANY_CD, :OLD.COMPANY_CD); END IF; IF V_REPORTING_ENTITY_CD IS NOT NULL OR :NEW.COMPANY_TYPE_CD = 'D' THEN IF (:NEW.CBC_GBE_SCOPE = 'Y' AND COALESCE (:OLD.CBC_GBE_SCOPE, 'N') = 'N') OR (COALESCE(:NEW.CBC_GBE_SCOPE, :OLD.CBC_GBE_SCOPE) = 'Y' AND V_LEGAL_COMPANY_CD <> COALESCE(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD)) THEN SELECT CBC_FLAG INTO V_REP_CBC_FLAG FROM CFG_V_REPORTING_ENTITIES WHERE REPORTING_ENTITY_CD = V_LEGAL_COMPANY_CD; IF COALESCE (V_REP_CBC_FLAG, 'N') = 'N' THEN RAISE EXCEPTION RU_NOT_IN_CBC_SCOPE; END IF; CNTR := 0; SELECT COUNT (*) INTO CNTR FROM CFG.CFG_V_COMPANY_ADDRESSES WHERE COMPANY_CD = V_REPORTING_ENTITY_CD AND ADDRESS_TYPE_CD = 'RES'; IF CNTR = 0 THEN RAISE EXCEPTION ERR_NO_ADR; END IF; SELECT VALID_FROM, COUNTRY_CD INTO V_ADDR_VALID_FROM_DATE, V_COUNTRY_CD FROM CFG.CFG_V_COMPANY_ADDRESSES WHERE COMPANY_CD = V_REPORTING_ENTITY_CD AND ADDRESS_TYPE_CD = 'RES'; IF V_LEGAL_COMPANY_CD <> COALESCE(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD) THEN V_ADDR_VALID_FROM_DATE := DATE_TRUNC(CURRENT_TIMESTAMP); END IF; MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_REPORTING_ENTITY_CD => V_REPORTING_ENTITY_CD, I_VALID_FROM_DATE => TRUNC (SYSDATE), I_VALID_TO_DATE => NULL, I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'CE', I_ACTION_TYPE => 'INSERT'); MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_REPORTING_ENTITY_CD => 'J-' || V_COUNTRY_CD, I_VALID_FROM_DATE => V_ADDR_VALID_FROM_DATE, I_VALID_TO_DATE => NULL, I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'JU', I_ACTION_TYPE => 'INSERT'); END IF; IF :NEW.CBC_GBE_SCOPE = 'N' AND COALESCE (:OLD.CBC_GBE_SCOPE, 'Y') = 'Y' THEN MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_VALID_FROM_DATE => NULL, I_VALID_TO_DATE => TRUNC (SYSDATE), I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'CE', I_ACTION_TYPE => 'UPDATE'); MDM_UTIL_COMPANIES.MODIFYCOMPANY(I_COMPANY_CD => :NEW.COMPANY_CD, I_VALID_FROM_DATE => NULL, I_VALID_TO_DATE => TRUNC (SYSDATE), I_CHANGE_USER => V_USERID, I_MAPPING_TYPE => 'JU', I_ACTION_TYPE => 'UPDATE'); END IF; END IF; CASE WHEN (COALESCE (:OLD.OFFICIAL_NAME, '-') != COALESCE (:NEW.OFFICIAL_NAME, '-')) AND :OLD.OFFICIAL_NAME IS NOT NULL THEN MDMAPPL.MDM_UTIL_COMPANIES.MODIFYCOMPANYNAME(:NEW.COMPANY_CD, V_LEGAL_COMPANY_CD, :NEW.OFFICIAL_NAME, V_USERID); ELSE NULL; END CASE; END IF; END; $$ LANGUAGE plpgsql;"
        }
    ],
    "on_delete": [
        {
            "type": "sql",
            "sql": "DO $$ DECLARE CNTR integer; V_USERID VARCHAR2(100); V_REPORTING_ENTITY_CD CFG_V_REPORTING_ENTITIES.REPORTING_ENTITY_CD%TYPE; V_LEGAL_COMPANY_CD CFG_V_COMPANIES.LEGAL_COMPANY_CD%TYPE; V_OLD_LEGAL_COMPANY_CD CFG_V_COMPANIES.LEGAL_COMPANY_CD%TYPE := 'NVL(:OLD.LEGAL_COMPANY_CD, :NEW.LEGAL_COMPANY_CD)'; V_REP_CBC_FLAG CFG_V_REPORTING_ENTITIES.CBC_FLAG%TYPE; V_ADDR_VALID_FROM_DATE CFG.CFG_V_COMPANY_ADDRESSES.VALID_FROM%TYPE; V_COUNTRY_CD CFG.CFG_V_COMPANY_ADDRESSES.COUNTRY_CD%TYPE; V_COMPANY_CODES_LIST VARCHAR2(200); BEGIN V_USERID := TXO_UTIL.GET_USERID; IF TRUE THEN RAISE EXCEPTION ERR_DEL; END IF; END; $$ LANGUAGE plpgsql;"
        }
    ]
}
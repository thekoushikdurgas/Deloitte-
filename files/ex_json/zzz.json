{
  "on_insert": [
    {
      "type": "sql",
      "sql": "DO $$ DECLARE v_count  INTEGER := 0; v_matl_count INTEGER := 0; v_record_count      INTEGER := 0; p_class VARCHAR (3); p_approval_user     VARCHAR (30); p_approval_date     DATE; v_market_auth_no    VARCHAR (48); BEGIN v_market_auth_no := TRIM (REPLACE ( :new_market_auth_no, CHR (9), ''));  IF :old_delete_flag = 'Y' THEN SELECT COUNT (mau_id) INTO v_record_count FROM coa.coa_market_auths_his a WHERE a.action = 'D' AND a.mau_id = :old_mau_id;  IF v_record_count > 0 THEN RAISE EXCEPTION 'This record has already been deleted and cannot be changed anymore'; END IF; END IF;  IF :new_delete_flag = 'Y' THEN IF ( :new_audit_comment = :old_audit_comment) THEN RAISE EXCEPTION 'Audit Comment has to be modified if the delete flag is set to yes'; END IF; END IF;  BEGIN SELECT class_cd INTO p_class FROM gmd.v_materials WHERE matl_no = :new_matl_no;  IF p_class NOT IN ('FIN') THEN RAISE EXCEPTION 'Material class should be selected as FIN'; END IF; EXCEPTION WHEN NO_DATA_FOUND THEN RAISE EXCEPTION 'No Data Found for Material No'; END;  SELECT COUNT (*) INTO v_matl_count FROM gmd.v_materials WHERE matl_no = :new_matl_no;  IF v_matl_count = 0 THEN RAISE EXCEPTION 'GENISYS material number is not a valid material'; END IF;  v_matl_count := 0; SELECT COUNT (*) INTO v_matl_count FROM coa.coa_market_auths WHERE matl_no = :new_matl_no AND country_id = :new_country_id;  IF v_matl_count = 1 THEN RAISE EXCEPTION 'TODO'; END IF;  INSERT INTO coa.coa_market_auths (country_id ,matl_no ,market_auth_no ,audit_comment ,defined_ind ,valid_ind, ins_date, ins_user) VALUES (:new_country_id , :new_matl_no ,v_market_auth_no , :new_audit_comment ,'N' , :new_valid_ind, :ins_date, :ins_user); END $$;"
    }
  ],
  "on_update": [
    {
      "type": "sql",
      "sql": "DO $$ DECLARE v_count  INTEGER := 0; v_matl_count INTEGER := 0; v_record_count  INTEGER := 0; p_class  VARCHAR (30); p_approval_user VARCHAR (30); p_approval_date     DATE; v_market_auth_no     VARCHAR (48); BEGIN v_market_auth_no := TRIM (REPLACE ( :new_market_auth_no, CHR (9), ''));  IF :old_delete_flag = 'Y' THEN SELECT COUNT (mau_id) INTO v_record_count FROM coa.coa_market_auths_his a WHERE a.action = 'D' AND a.mau_id = :old_mau_id;  IF v_record_count > 0 THEN RAISE EXCEPTION 'This record has already been deleted and cannot be changed anymore'; END IF; END IF;  IF :new_delete_flag = 'Y' THEN IF ( :new_audit_comment = :old_audit_comment) THEN RAISE EXCEPTION 'Audit Comment has to be modified if the delete flag is set to yes'; END IF; END IF;  BEGIN SELECT class_cd INTO p_class FROM gmd.v_materials WHERE matl_no = :new_matl_no;  IF p_class NOT IN ('FIN') THEN RAISE EXCEPTION 'Material class should be selected as FIN'; END IF; EXCEPTION WHEN NO_DATA_FOUND THEN RAISE EXCEPTION 'No Data Found for Material No'; END;  SELECT COUNT (*) INTO v_matl_count FROM gmd.v_materials WHERE matl_no = :new_matl_no;  IF v_matl_count = 0 THEN RAISE EXCEPTION 'GENISYS material number is not a valid material'; END IF;  IF ( :old_matl_no <> :new_matl_no OR :new_country_id <> :old_country_id) THEN RAISE EXCEPTION 'Material number or Country code should not change for a specific Marketing Auhorization No'; END IF;  IF :new_defined_ind = :old_defined_ind THEN IF :new_audit_comment IS NULL THEN RAISE EXCEPTION 'Update Audit comment if approval flag  is set to yes'; END IF; END IF;  IF     ( :new_defined_ind = 'Y' AND :old_defined_ind = 'N') AND (:ins_user = COALESCE (:old_upd_user, :old_ins_user)) THEN RAISE EXCEPTION 'Update user should be different from  insert user when the approval flag is set to yes'; END IF;  IF     ( :new_defined_ind = 'Y' AND :old_defined_ind = 'N') AND (   :old_matl_no <> :new_matl_no OR :old_market_auth_no <> v_market_auth_no OR :old_audit_comment <> :new_audit_comment OR :old_valid_ind <> :new_valid_ind) THEN RAISE EXCEPTION 'No changes has been made to Material No, Marketing Authorization Number, Audit Comment, Valid Indicator'; END IF;  IF     ( :old_defined_ind = 'N' AND :new_defined_ind = 'Y') AND (:ins_user <> COALESCE ( :old_upd_user, :old_ins_user)) AND (   :old_matl_no = :new_matl_no OR :old_market_auth_no = v_market_auth_no OR :old_audit_comment = :new_audit_comment OR :old_valid_ind = :new_valid_ind) THEN p_approval_user := :ins_user; p_approval_date := SYSDATE;  UPDATE coa.coa_market_auths SET defined_ind = 'Y' ,def_date = SYSDATE ,def_user = coa_util.get_changing_user, upd_user =:ins_user, upd_date = :ins_date WHERE mau_id = :new_mau_id; ELSE  UPDATE coa.coa_market_auths SET country_id = :new_country_id ,matl_no = :new_matl_no ,market_auth_no = v_market_auth_no ,audit_comment = :new_audit_comment ,defined_ind = 'N' , valid_ind = :new_valid_ind ,upd_no = COALESCE(upd_no, 0) + 1 ,def_date = NULL ,def_user = NULL, upd_user =:ins_user, upd_date = :ins_date WHERE mau_id = :new_mau_id;  IF :new_delete_flag = 'Y' THEN DELETE FROM coa.coa_market_auths WHERE country_id = :new_country_id AND matl_no = :new_matl_no; END IF; END IF; END $$;"
    }
  ]
}

{
    "on_insert": [
        {
            "type": "sql",
            "sql": "DO $$ DECLARE v_counter integer; v_code varchar(2); v_odg_no varchar(2); v_resgrp_cd varchar(2); v_reslin_cd varchar(2); v_status_cd varchar(1); v_dba_cd integer; v_portf_proj_cd varchar(1); v_description varchar(500); v_reslin_desc varchar(60); v_theme_desc_length integer; v_d_registrat_date date; v_d_ins_date date; v_future_registrat date; v_valid_to date; v_userid varchar(30); v_sec_mol_cnt integer := 0; v_molecule_id varchar(5) := null; v_molecule_rg_no varchar(20) := null; v_molec_in_lic_prtnr varchar(15) := null;i1 RECORD; v_new_rg_no  GMD.v_theme_molecules.rg_no%type; v_comparator_ind GMD.v_theme_molecules.comparator_ind%type; v_theme_desc_proposal MDMAPPL.mdm_v_themes_mtn.theme_desc_proposal%type; v_short_name varchar(30); c_molecule_type_id constant GMD.v_molecule_types.molecule_type_id%type := 99; c_pharmacological_type_id constant GMD.v_pharmacological_types.pharmacological_type_id%type := 19; v_evolved_nmp_cnt integer; v_trademark_no gmd.v_themes.trademark_no%type; v_molecule_type_id GMD.v_molecule_types.molecule_type_id%type; v_pharmacological_type_id GMD.v_pharmacological_types.pharmacological_type_id%type;begin v_userid:= :ins_user; SELECT new_rg_no INTO v_new_rg_no FROM ( SELECT rn AS new_rg_no FROM generate_series(6000, 6999) AS rn EXCEPT SELECT rg_no::INTEGER FROM gmd.v_theme_molecules_mrhub) AS free_rg LIMIT 1;if (:new_in_prep_ind = 'Y') then if (:new_portf_proj_cd <> 'Y') then raise EXCEPTION 'MDM_V_THEMES_IOF: In-prep theme must be portfolio project'; end if; if (:new_molecule_id is null) then CALL tvdxora_v3_00.txo_util$set_warning(format('No Molecule assigned to In-Prep Theme %s!', :new_theme_no)); RAISE EXCEPTION 'MDM_V_THEMES_IOF: Molecule Id must be entered' ; end if; end if; if (:new_molecule_id is not null) then begin select rg_no ,m.comparator_ind into v_molecule_rg_no ,v_comparator_ind from gmd.v_theme_molecules_mrhub m where molecule_id = CAST(NULLIF(CAST(:new_molecule_id AS TEXT),'') AS NUMERIC) and m.valid_ind = 'Y'; EXCEPTION WHEN OTHERS THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: This is not a valid Molecule ID'; end; if (v_molecule_rg_no is null) then if (v_comparator_ind = 'Y') then null; else update gmd.theme_molecules set rg_no = v_new_rg_no,upd_user= :upd_user,upd_date= :upd_date where molecule_id = CAST(NULLIF(CAST(:new_molecule_id AS TEXT),'') AS NUMERIC); end if; end if; end if;v_odg_no := SUBSTRING(:new_reslin_desc_concat FROM 1 FOR 2); v_resgrp_cd := SUBSTRING(:new_reslin_desc_concat FROM 4 FOR 2 ); v_reslin_cd := SUBSTRING(:new_reslin_desc_concat FROM 7 FOR 2); v_reslin_desc := SUBSTRING(:new_reslin_desc_concat FROM 12);if (:new_status_desc is not null) then select status_cd into v_status_cd from mdmappl.mdm_v_theme_status where state_desc = :new_status_desc; else v_status_cd := null; end if; if (:new_dba_desc_concat is not null) then select dba_cd into v_dba_cd from mdmappl.mdm_v_disease_biology_areas where dba_short_desc || ' - ' || dba_desc = :new_dba_desc_concat; else v_dba_cd := null; end if; v_molec_in_lic_prtnr := GMD.gmd_util_themes$get_molec_in_lic_prtnr(cast(:new_molecule_id as text)); if (:new_official_ind = 'N') THEN v_trademark_no := :new_trademark_no; ELSE v_trademark_no := NULL; END IF;v_theme_desc_proposal := gmd.gmd_util_themes$get_theme_short_name_mrhub( cast(:new_theme_no as text), cast(:new_molecule_id as text), :new_prod_short_cd, v_odg_no, v_resgrp_cd, v_reslin_cd, :new_line_ext_info, NULL, v_trademark_no::text, 'N' ); if (:new_manual_short_desc is null and length(v_theme_desc_proposal) > 30) then raise EXCEPTION 'MDM_V_THEMES_IOF: The automatically generated Short Description Proposal % is too long',v_theme_desc_proposal; end if; v_short_name := coalesce(:new_manual_short_desc, v_theme_desc_proposal);v_molecule_id := :new_molecule_id; if (:new_portf_proj_cd = 'Y' and :new_molecule_id is null) then if COALESCE(:new_manual_short_desc, :new_theme_desc_proposal) IS NULL then raise EXCEPTION 'MDM_V_THEMES_IOF: Portfolio project molecule creation error'; else insert into gmd.theme_molecules(molecule_desc, valid_ind ,rg_no ,cancer_immunotherapy_ind ,molecule_type_id ,pharmacological_type_id,ins_user,ins_date) values (COALESCE(:new_manual_short_desc, :new_theme_desc_proposal),'Y',v_new_rg_no,'N',c_molecule_type_id,c_pharmacological_type_id,:ins_user,:ins_date); select molecule_id into v_molecule_id from gmd.v_theme_molecules_mrhub where molecule_desc = COALESCE(:new_manual_short_desc, :new_theme_desc_proposal) and valid_ind = 'Y' and rg_no = v_new_rg_no and cancer_immunotherapy_ind = 'N' and molecule_type_id = c_molecule_type_id and pharmacological_type_id = c_pharmacological_type_id; insert into gmd.theme_molecule_map (theme_no ,molecule_id ,molecule_seq_no ,valid_ind,ins_user,ins_date) values (:new_theme_no, COALESCE(v_molecule_id,''), 1, 'Y',:ins_user,:ins_date); end if; end if; IF (length(cast(:new_theme_no as text)) = 4 AND (substr(cast(:new_theme_no as text),1,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),2,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),3,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),4,1) !~ '^[0-9]$')) OR (length(cast(:new_theme_no as text)) = 5 AND (substr(cast(:new_theme_no as text),1,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),2,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),3,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),4,1) !~ '^[0-9]$' OR substr(cast(:new_theme_no as text),5,1) !~ '^[0-9]$')) OR (length(cast(:new_theme_no as text)) <> 4 AND length(cast(:new_theme_no as text)) <> 5) THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: This is not a valid Theme No'; END IF; v_counter := null; select count(t.theme_no) into v_counter from (select theme_no from gmd.v_themes union all select theme_no from gmd.themes_archive) t where t.theme_no = cast(:new_theme_no as text); if (v_counter > 0) then raise EXCEPTION 'MDM_V_THEMES_IOF: This Theme No already exists'; end if; v_counter := null; v_d_registrat_date := CURRENT_DATE; if (:new_official_ind = 'N') then raise EXCEPTION 'MDM_V_THEMES_IOF: New Themes can only be inserted by Official Changes';  end if;  if (upper(:new_portf_proj_cd) = 'N') then if (:new_theme_desc is null or length(:new_theme_desc) = 0) then raise EXCEPTION 'MDM_V_THEMES_IOF: If Pharma Rx Portfolio Project is set to \"No\", then the Theme Description must be filled'; end if; end if; if (upper(:new_portf_proj_cd) = 'Y')   AND (v_status_cd <> 'C'  OR :new_in_prep_ind = 'Y') then v_description := gmd.gmd_util_themes$get_theme_desc_portfolio(p_theme_no_portf => null, p_molecule_id_portf => v_molecule_id, p_prod_short_cd_portf => :new_prod_short_cd, p_odg_no_port => v_odg_no, p_resgrp_cd_port => v_resgrp_cd, p_reslin_cd_port => v_reslin_cd, p_line_ext_info_port => :new_line_ext_info, p_in_lic_prtnr_portf => v_molec_in_lic_prtnr, p_trademark_no_portf => :new_trademark_no, p_short_name_portf => :new_short_name, p_trunc_desc_length => 'N'); if (length(v_description) > 90) then raise EXCEPTION 'MDM_V_THEMES_IOF: The automatically generated Theme Description % is too long',v_description; end if; v_description := trim(v_description); v_portf_proj_cd := 'Y'; else v_description := :new_theme_desc; v_portf_proj_cd := 'N';end if;v_counter := null; select count(t.theme_no) into v_counter from gmd.v_themes t where t.theme_desc = v_description; if (v_counter > 0) then raise EXCEPTION 'MDM_V_THEMES_IOF: This Theme Description already exists';end if;v_counter := null; v_valid_to := to_date('09.09.9999', 'DD.MM.YYYY'); v_short_name := COALESCE(:new_manual_short_desc, substr(v_description, 1, 30));insert into gmd.themes(theme_no, registrat_date, odg_no, resgrp_cd, reslin_cd, theme_desc, short_name, status_cd, dba_cd, in_prep_ind, prod_short_cd, trademark_no, bio_activity, applicant, contact, registrar, line_ext_info, portf_proj_cd, co_dev_prtnr, technology_prtnr, official_ind, co_mar_prtnr, valid_to, portf_da_group_id, manual_short_desc,ins_user,ins_date,upd_user,upd_date) values (:new_theme_no, v_d_registrat_date, v_odg_no, v_resgrp_cd, v_reslin_cd, COALESCE(v_description,''), v_short_name, v_status_cd, v_dba_cd, :new_in_prep_ind, :new_prod_short_cd, CAST(NULLIF(cast(:new_trademark_no as text),'') AS NUMERIC), :new_bio_activity, :new_applicant, :new_contact, :ins_user, :new_line_ext_info, v_portf_proj_cd, :new_co_dev_prtnr, :new_technology_prtnr, :new_official_ind, :new_co_mar_prtnr, v_valid_to, CAST(NULLIF(cast(:new_portf_da_group_id as text),'') AS NUMERIC), :new_manual_short_desc,:ins_user,:ins_date,NULL,NULL);if :new_molecule_id is not null then insert into gmd.theme_molecule_map(theme_no ,molecule_id ,molecule_seq_no ,valid_ind,ins_user,ins_date) values (:new_theme_no, COALESCE(v_molecule_id,''), 1, 'Y',:ins_user,:ins_date); end if;IF (:new_proposal_id IS NOT NULL) THEN SELECT count() INTO v_evolved_nmp_cnt FROM predmd.new_medicine_proposals WHERE proposal_id = CAST(NULLIF(CAST(:new_proposal_id AS TEXT), '') AS NUMERIC) AND proposal_status_cd = 'E'; IF (v_evolved_nmp_cnt = 0) THEN UPDATE predmd.new_medicine_proposals SET proposal_status_cd = 'E', evolved_theme_no = :new_theme_no, proposal_name = v_short_name, reason_for_change = '* Automatic update of proposal_name after short_name change in evolved theme *',upd_user= :upd_user ,upd_date= :upd_date WHERE proposal_id =  CAST(NULLIF(CAST(:new_proposal_id AS TEXT), '') AS NUMERIC); END IF; END IF;IF (:new_theme_no IS NOT NULL AND gmd.gmd_util_themes$get_themes_range_automatic_nmp(CAST(:new_theme_no AS TEXT)) = 'Y') THEN IF :new_proposal_id IS NOT NULL THEN SELECT count() INTO v_evolved_nmp_cnt FROM predmd.new_medicine_proposals WHERE proposal_id =  CAST(NULLIF(CAST(:new_proposal_id AS TEXT), '') AS NUMERIC) AND proposal_name = v_short_name AND proposal_status_cd = 'E'; END IF; IF :new_proposal_id IS NULL OR (:new_proposal_id IS NOT NULL AND v_evolved_nmp_cnt = 0) THEN IF (:new_molecule_id IS NOT NULL) THEN BEGIN SELECT pharmacological_type_id, molecule_type_id into v_pharmacological_type_id, v_molecule_type_id from gmd.v_theme_molecules_mrhub m left join MDMAPPL.MDM_V_PRODUCT_FAMILIES B on m.PRODUCT_FAMILY_CD = B.PRODUCT_FAMILY_CD where m.valid_ind = 'Y' and molecule_id = cast(nullif(cast(:new_molecule_id as TEXT), '') as numeric); exception when OTHERS then raise exception 'MDM_V_THEMES_IOF: This is not a valid Molecule ID'; END; END IF; INSERT INTO predmd.new_medicine_proposals (proposal_status_cd, evolved_theme_no, proposal_name, pharmacological_type_id, molecule_type_id, reason_for_change,ins_user,ins_date) VALUES ('E', :new_theme_no, v_short_name, COALESCE(v_pharmacological_type_id, c_pharmacological_type_id), COALESCE(v_molecule_type_id, c_molecule_type_id), '* Automatic creation of nmp for early development themes *',:ins_user,:ins_date); END IF; END IF;BEGIN FOR i1 IN (SELECT a.theme_no, a.registrat_date FROM gmd.v_themes a WHERE a.valid_to <= CURRENT_DATE) LOOP DELETE FROM gmd.themes WHERE theme_no = i1.theme_no AND registrat_date = i1.registrat_date; END LOOP;END; END $$;"
        }
    ],
    "on_update": [
        {
            "type": "sql",
            "sql": " DO $$ DECLARE v_counter INTEGER; v_odg_no VARCHAR(2); v_resgrp_cd VARCHAR(2); v_reslin_cd VARCHAR(2); v_status_cd VARCHAR(1); v_dba_cd INTEGER; v_portf_proj_cd VARCHAR(1); v_description VARCHAR(500); v_reslin_desc VARCHAR(60); v_d_registrat_date VARCHAR(30); v_valid_to DATE; v_sec_mol_cnt INTEGER := 0; v_molecule_id VARCHAR(5) := NULL; v_molecule_rg_no VARCHAR(20) := NULL; v_molec_in_lic_prtnr VARCHAR(15) := NULL; v_new_rg_no INTEGER; v_comparator_ind VARCHAR(1); v_theme_desc_proposal VARCHAR(500); v_short_name VARCHAR(30); v_evolved_nmp_cnt INTEGER; v_trademark_no VARCHAR(20); i1 RECORD; v_userid varchar(30); BEGIN v_userid := :upd_user; SELECT new_rg_no INTO v_new_rg_no FROM ( SELECT rn AS new_rg_no FROM generate_series(6000, 6999) AS rn EXCEPT SELECT rg_no::INTEGER FROM gmd.v_theme_molecules_mrhub ) AS free_rg LIMIT 1; IF :new_in_prep_ind = 'Y' THEN IF :new_portf_proj_cd <> 'Y' THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF:In-prep theme must be portfolio project'; END IF; IF :new_molecule_id IS NULL THEN CALL tvdxora_v3_00.txo_util$set_warning('No Molecule assigned to In-Prep Theme ' || :new_theme_no || '!'); END IF; END IF; IF :new_molecule_id IS NOT NULL THEN BEGIN select rg_no ,m.comparator_ind into v_molecule_rg_no ,v_comparator_ind from gmd.v_theme_molecules_mrhub m left join MDMAPPL.MDM_V_PRODUCT_FAMILIES B on m.PRODUCT_FAMILY_CD = B.PRODUCT_FAMILY_CD where m.valid_ind = 'Y' and molecule_id = CAST(NULLIF(CAST(:new_molecule_id AS TEXT),'') AS NUMERIC) ; IF v_molecule_rg_no IS NULL AND v_comparator_ind IS NULL THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: This is not a valid Molecule ID'; END IF; EXCEPTION WHEN OTHERS THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: This is not a valid Molecule ID'; END; IF v_molecule_rg_no IS NULL THEN IF v_comparator_ind = 'Y' THEN NULL; ELSE UPDATE gmd.theme_molecules SET rg_no = v_new_rg_no WHERE molecule_id = :new_molecule_id; END IF; END IF; END IF; v_odg_no := SUBSTRING(:new_reslin_desc_concat FROM 1 FOR 2); v_resgrp_cd := SUBSTRING(:new_reslin_desc_concat FROM 4 FOR 2); v_reslin_cd := SUBSTRING(:new_reslin_desc_concat FROM 7 FOR 2); v_reslin_desc := substring(:new_reslin_desc_concat FROM 12 for length(:new_reslin_desc_concat)); IF :new_status_desc IS NOT NULL THEN SELECT status_cd INTO v_status_cd FROM mdmappl.mdm_v_theme_status WHERE state_desc = :new_status_desc; ELSE v_status_cd := NULL; END IF; IF :new_dba_desc_concat IS NOT NULL THEN SELECT dba_cd INTO v_dba_cd FROM mdmappl.mdm_v_disease_biology_areas WHERE dba_short_desc || ' - ' || dba_desc = :new_dba_desc_concat; ELSE v_dba_cd := NULL; END IF; v_molec_in_lic_prtnr := GMD.gmd_util_themes$get_molec_in_lic_prtnr(cast(:new_molecule_id as text)); IF :new_official_ind = 'N' THEN v_trademark_no := :new_trademark_no; ELSE v_trademark_no := :old_trademark_no; END IF; v_theme_desc_proposal := GMD.gmd_util_themes$get_theme_short_name_mrhub( cast(:new_theme_no as text), cast(:new_molecule_id as text), :new_prod_short_cd, v_odg_no, v_resgrp_cd, v_reslin_cd, :new_line_ext_info, NULL, v_trademark_no, 'N' ); IF :new_manual_short_desc IS NULL AND LENGTH(v_theme_desc_proposal) > 30 THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: Theme desc proposal too long'; END IF; v_short_name := COALESCE(:new_manual_short_desc, v_theme_desc_proposal); IF :new_theme_no <> :old_theme_no THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: Theme number cannot be updated'; END IF; IF :new_official_ind = 'N' THEN v_d_registrat_date := :old_registrat_date; ELSE v_d_registrat_date := CAST(CURRENT_DATE as text); END IF; IF (UPPER(:new_portf_proj_cd) = 'Y' AND (v_status_cd <> 'C' OR :new_in_prep_ind = 'Y')) THEN v_description := GMD.gmd_util_themes$get_theme_desc_portfolio( p_theme_no_portf => :new_theme_no, p_molecule_id_portf => cast(:new_molecule_id as text), p_prod_short_cd_portf => :new_prod_short_cd, p_odg_no_port => v_odg_no, p_resgrp_cd_port => v_resgrp_cd, p_reslin_cd_port => v_reslin_cd, p_line_ext_info_port => :new_line_ext_info, p_in_lic_prtnr_portf => v_molec_in_lic_prtnr, p_trademark_no_portf => :new_trademark_no, p_short_name_portf => :new_short_name, p_trunc_desc_length => 'N' ); v_description := TRIM(v_description); v_portf_proj_cd := 'Y'; ELSE IF (:new_theme_desc IS NULL OR LENGTH(:new_theme_desc) = 0) THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF:Theme description is mandatory'; ELSE v_description := :new_theme_desc; v_portf_proj_cd := :new_portf_proj_cd; END IF; END IF; IF (LENGTH(v_description) > 90) THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: Description too long'; END IF; v_counter := NULL; SELECT COUNT(t.theme_no) INTO v_counter FROM gmd.v_themes t WHERE t.theme_desc = v_description AND t.theme_no <> :new_theme_no; IF v_counter > 0 THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: Theme description not unique'; END IF; v_counter := NULL; IF :new_official_ind = 'N' THEN UPDATE gmd.themes SET odg_no = v_odg_no, resgrp_cd = v_resgrp_cd, reslin_cd = v_reslin_cd, theme_desc = COALESCE(v_description, ''), short_name = v_short_name, status_cd = v_status_cd, dba_cd = v_dba_cd, in_prep_ind = :new_in_prep_ind, prod_short_cd = :new_prod_short_cd, trademark_no = CAST(NULLIF(cast(:new_trademark_no as text), '') AS NUMERIC), bio_activity = :new_bio_activity, applicant = :new_applicant, contact = :new_contact, line_ext_info = :new_line_ext_info, portf_proj_cd = v_portf_proj_cd, co_dev_prtnr = :new_co_dev_prtnr, technology_prtnr = :new_technology_prtnr, official_ind = :new_official_ind, co_mar_prtnr = :new_co_mar_prtnr, portf_da_group_id = :new_portf_da_group_id, manual_short_desc = :new_manual_short_desc, upd_user = :upd_user, upd_date = :upd_date WHERE theme_no = :new_theme_no AND DATE(registrat_date) = TO_DATE(v_d_registrat_date, 'DD-MM-YYYY'); ELSE v_counter := NULL; SELECT COUNT() INTO v_counter FROM gmd.v_themes t WHERE date(t.registrat_date) = CURRENT_DATE AND t.theme_no = :new_theme_no; IF v_counter > 0 THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: Only one official change per day allowed'; END IF; v_counter := NULL; UPDATE gmd.themes SET odg_no = v_odg_no, resgrp_cd = v_resgrp_cd, reslin_cd = v_reslin_cd, theme_desc = COALESCE(v_description, ''), short_name = v_short_name, status_cd = v_status_cd, dba_cd = v_dba_cd, in_prep_ind = :new_in_prep_ind, prod_short_cd = :new_prod_short_cd, trademark_no = CAST(NULLIF(cast(:new_trademark_no as text), '') AS NUMERIC), bio_activity = :new_bio_activity, applicant = :new_applicant, contact = :new_contact, line_ext_info = :new_line_ext_info, portf_proj_cd = v_portf_proj_cd, co_dev_prtnr = :new_co_dev_prtnr, technology_prtnr = :new_technology_prtnr, official_ind = :new_official_ind, co_mar_prtnr = :new_co_mar_prtnr, registrat_date = CURRENT_DATE, registrar = v_userid, portf_da_group_id = :new_portf_da_group_id, manual_short_desc = :new_manual_short_desc, upd_user = :upd_user, upd_date = :upd_date WHERE theme_no = :new_theme_no; END IF; IF (:old_molecule_id IS NULL AND :new_molecule_id IS NOT NULL) THEN INSERT INTO gmd.theme_molecule_map( theme_no, molecule_id, molecule_seq_no, valid_ind, ins_user, ins_date ) VALUES ( :new_theme_no, :new_molecule_id, 1, 'Y', :ins_user, :ins_date ); ELSIF (:old_molecule_id IS NOT NULL AND :new_molecule_id IS NOT NULL) THEN UPDATE mdmappl.mdm_v_theme_molecule_map SET molecule_id = :new_molecule_id, valid_ind = 'Y', upd_user = :upd_user, upd_date = :upd_date WHERE theme_no = :new_theme_no AND molecule_seq_no = 1 AND valid_ind = 'Y'; ELSIF (:old_molecule_id IS NOT NULL AND :new_molecule_id IS NULL) THEN SELECT COUNT() INTO v_sec_mol_cnt FROM mdmappl.mdm_v_theme_molecule_map_mtn WHERE theme_no = :new_theme_no AND molecule_seq_no > 1 AND valid_ind = 'Y'; IF v_sec_mol_cnt > 0 THEN RAISE EXCEPTION 'MDM_V_THEMES_IOF: Secondary molecule list not empty'; ELSE UPDATE mdmappl.mdm_v_theme_molecule_map SET valid_ind = 'N', upd_user = :upd_user, upd_date = :upd_date WHERE molecule_id = :old_molecule_id AND theme_no = :new_theme_no AND molecule_seq_no = 1 AND valid_ind = 'Y'; END IF; ELSE NULL; END IF; IF(:new_proposal_id IS NOT NULL AND (:old_proposal_id IS NULL)) THEN SELECT COUNT() INTO v_evolved_nmp_cnt FROM mdmappl.mdm_v_new_medicine_proposals_mtn WHERE proposal_id = CAST(NULLIF(:new_proposal_id, NULL) AS NUMERIC) AND proposal_status_cd = 'E'; IF v_evolved_nmp_cnt = 0 THEN UPDATE predmd.new_medicine_proposals SET proposal_status_cd = 'E', evolved_theme_no = :new_theme_no, proposal_name = v_short_name, reason_for_change = '* Automatic update of proposal_name after short_name change in evolved theme *', upd_user = :upd_user, upd_date = :upd_date WHERE proposal_id = CAST(NULLIF(:new_proposal_id, NULL) AS NUMERIC); END IF; ELSE IF (:new_proposal_id IS NULL AND :old_proposal_id IS NOT NULL) THEN UPDATE predmd.new_medicine_proposals SET proposal_status_cd = 'A', evolved_theme_no = NULL, upd_user = :upd_user, upd_date = :upd_date WHERE proposal_id = :old_proposal_id; ELSE IF(:new_proposal_id IS NOT NULL AND :old_proposal_id IS NOT NULL AND :new_proposal_id <> :old_proposal_id) THEN UPDATE predmd.new_medicine_proposals SET proposal_status_cd = 'A', evolved_theme_no = NULL, upd_user = :upd_user, upd_date = :upd_date WHERE proposal_id = :old_proposal_id; UPDATE predmd.new_medicine_proposals SET proposal_status_cd = 'E', evolved_theme_no = :new_theme_no, proposal_name = v_short_name, reason_for_change = '* Automatic update of proposal_name after short_name change in evolved theme *', upd_user = :upd_user, upd_date = :upd_date WHERE proposal_id = CAST(NULLIF(:new_proposal_id, NULL) AS NUMERIC); END IF; END IF; END IF; IF (COALESCE(CAST(NULLIF(:new_proposal_id, NULL) AS NUMERIC), 0) = COALESCE(CAST(NULLIF(:old_proposal_id, NULL) AS NUMERIC), 0) AND COALESCE(:old_short_name, '-') <> COALESCE(v_short_name, '-')) THEN SELECT COUNT() INTO v_evolved_nmp_cnt FROM mdmappl.mdm_v_new_medicine_proposals_mtn nmp WHERE nmp.evolved_theme_no = :new_theme_no AND nmp.proposal_status_cd = 'E'; IF v_evolved_nmp_cnt > 0 THEN UPDATE predmd.new_medicine_proposals nmp SET proposal_name = v_short_name, reason_for_change = '* Automatic update of proposal_name after short_name change in evolved theme *', upd_user = :upd_user, upd_date = :upd_date WHERE evolved_theme_no = :new_theme_no AND proposal_status_cd = 'E'; END IF; END IF; BEGIN FOR i1 IN (SELECT a.theme_no, a.registrat_date FROM gmd.v_themes a WHERE a.valid_to <= CURRENT_DATE) LOOP DELETE FROM gmd.themes WHERE theme_no = i1.theme_no AND registrat_date = i1.registrat_date; END LOOP; END; END $$; "
        }
    ],
    "on_delete": [
        {
            "type": "sql",
            "sql": "DO $$ DECLARE v_is_admin_cnt INTEGER := 0; v_userid VARCHAR(30); i1 RECORD; BEGIN IF TO_DATE(:old_registrat_date, 'DD-MM-YYYY') = CURRENT_DATE THEN DELETE FROM gmd.themes WHERE theme_no = :old_theme_no AND registrat_date::date = CURRENT_DATE; ELSE RAISE EXCEPTION 'MDM_V_THEMES_IOF:Theme cannot be deleted after the day of insertion'; END IF; FOR i1 IN (SELECT a.theme_no, a.registrat_date FROM gmd.v_themes a WHERE a.valid_to <= CURRENT_DATE) LOOP DELETE FROM gmd.themes WHERE theme_no = i1.theme_no AND registrat_date = i1.registrat_date;END LOOP; END $$;"
        }
    ]
}
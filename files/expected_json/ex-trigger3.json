{
    "on_insert":[
        {
            "type":"sql",
            "sql":"DO $$ DECLARE v_trigger_name VARCHAR(100) := 'COMPANY_ADDRESSES_IOF'; cntr INTEGER; v_userid VARCHAR(100); v_country_cd core.countries.country_cd%type; v_company_type_cd CFG.CFG_COMPANIES.COMPANY_TYPE_CD%type; v_valid_from CFG.CFG_COMPANY_ADDRESSES.VALID_FROM%type;BEGIN v_userid := :new_ins_user;cntr := 0;SELECT COUNT(*) INTO cntr FROM cfg.cfg_v_company_addresses WHERE company_cd =:new_company_cd AND address_type_cd = :new_address_type_cd;IF cntr > 0 THEN RAISE EXCEPTION 'COMPANY_ADDRESSES_IOF: An address already exists for this Company and Address type. To modify the existing address, please use the Update button.';END IF;SELECT company_type_cd INTO v_company_type_cd FROM cfg_v_companies WHERE company_cd = :new_company_cd; IF v_company_type_cd NOT IN ('L','A') AND :new_address_type_cd IN ('L') THEN RAISE EXCEPTION 'COMPANY_ADDRESSES_IOF: The legal address cannot be inserted for this type of company'; END IF; IF :new_address_type_cd IN ('P','L') THEN IF cntr = 0 THEN mdmappl.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'INSERT'); END IF; END IF;IF :new_address_type_cd NOT IN ('P','L') THEN IF cntr = 0 THEN MDMAPPL.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'INSERT'); ELSE MDMAPPL.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'UPDATE'); END IF; END IF;END; $$;"
        }
    ],
    "on_update":[
        {
            "type":"sql",
            "sql":"DO $$ DECLARE v_trigger_name VARCHAR(100) := 'COMPANY_ADDRESSES_IOF'; cntr INTEGER; v_userid VARCHAR(100); v_country_cd core.countries.country_cd%type; v_company_type_cd CFG.CFG_COMPANIES.COMPANY_TYPE_CD%type; v_valid_from CFG.CFG_COMPANY_ADDRESSES.VALID_FROM%type;BEGIN v_userid := :new_upd_user;cntr := 0;SELECT COUNT() INTO cntr FROM cfg.cfg_v_company_addresses WHERE company_cd = COALESCE(:new_company_cd, :old_company_cd) AND address_type_cd = COALESCE(:new_address_type_cd, :old_address_type_cd);SELECT company_type_cd INTO v_company_type_cd FROM cfg_v_companies WHERE company_cd = COALESCE(:new_company_cd, :old_company_cd); IF v_company_type_cd NOT IN ('L','A') AND COALESCE(:new_address_type_cd, :old_address_type_cd) IN ('L') THEN RAISE EXCEPTION 'COMPANY_ADDRESSES_IOF: The legal address cannot be inserted for this type of company'; END IF; IF COALESCE(:new_address_type_cd, :old_address_type_cd) IN ('P','L') THEN IF COALESCE(:old_valid_from, date_trunc('day', NOW())) = COALESCE(:new_valid_from, date_trunc('day', NOW())) AND :old_country_id <> :new_country_id THEN RAISE err_ctry_chg; END IF; IF cntr = 0 THEN mdmappl.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'INSERT'); ELSE IF COALESCE(:old_valid_from, date_trunc('day', NOW())) = COALESCE(:new_valid_from, date_trunc('day', NOW())) AND :old_country_id <> :new_country_id THEN MDMAPPL.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'CTRY_CHANGE'); cntr := 0; SELECT count() INTO cntr FROM cfg_v_companies WHERE company_cd = :new_company_cd AND valid_ind = 'Y' AND cbc_gbe_scope = 'Y' AND company_type_cd IN ('B','L'); IF :new_address_type_cd = 'P' AND cntr > 0 THEN SELECT country_cd INTO v_country_cd FROM mdm_v_countries WHERE country_id = :new_country_id; IF to_char(:new_valid_from, 'dd.mm') = '01.01' THEN v_valid_from := (date_trunc('year', :new_valid_from)::date + interval '10 months')::date; ELSE v_valid_from := (date_trunc('year', :new_valid_from)::date + interval '22 months')::date; END IF; MDMAPPL.mdm_util_companies.modifycompanymapping_ce_ju(i_company_cd => :new_company_cd, i_reporting_entity_cd => 'J-' || v_country_cd, i_valid_from_date => v_valid_from, i_valid_to_date => NULL, i_change_user => v_userid, i_mapping_type => 'JU', i_action_type => 'INSERT'); IF v_company_type_cd = 'L' THEN FOR v_rec IN (SELECT company_cd FROM cfg_v_companies WHERE legal_company_cd = :new_company_cd AND valid_ind = 'Y' AND cbc_gbe_scope = 'Y' AND company_type_cd IN ('O','V')) LOOP MDMAPPL.mdm_util_companies$modifycompanymapping_ce_ju(i_company_cd => v_rec.company_cd, i_reporting_entity_cd => 'J-' || v_country_cd, i_valid_from_date => v_valid_from, i_valid_to_date => NULL, i_change_user => v_userid, i_mapping_type => 'JU', i_action_type => 'INSERT'); END LOOP; END IF; END IF; ELSE MDMAPPL.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'UPDATE'); END IF; END IF; END IF;IF COALESCE(:new_address_type_cd, :old_address_type_cd) NOT IN ('P','L') THEN IF cntr = 0 THEN MDMAPPL.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'INSERT'); ELSE MDMAPPL.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => :new_company_cd, p_address_type_cd => :new_address_type_cd, p_additional_name => :new_additional_name, p_street => :new_street, p_house_no => :new_house_no, p_building => :new_building, p_additional_info => :new_additional_info, p_zip_code => :new_zip_code, p_city => :new_city, p_district_name => :new_district_name, p_country_id => :new_country_id, p_latitude => :new_latitude, p_longitude => :new_longitude, p_address_remark => :new_address_remark, p_valid_from => :new_valid_from, p_action_type => 'UPDATE'); END IF; END IF; END;$$;"
        }
    ],
    "on_delete":[
        {
            "type":"sql",
            "sql":"DO $$ DECLARE v_trigger_name VARCHAR(100) := 'COMPANY_ADDRESSES_IOF'; cntr INTEGER; v_userid VARCHAR(100); v_country_cd core.countries.country_cd%type; v_company_type_cd CFG.CFG_COMPANIES.COMPANY_TYPE_CD%type; v_valid_from CFG.CFG_COMPANY_ADDRESSES.VALID_FROM%type;BEGIN v_userid := :new_upd_user;cntr := 0;SELECT COUNT(*) INTO cntr FROM cfg.cfg_v_company_addresses WHERE company_cd = COALESCE(:new_company_cd, :old_company_cd) AND address_type_cd = COALESCE(:new_address_type_cd, :old_address_type_cd);IF COALESCE(:new_address_type_cd, :old_address_type_cd) in ('L','P') THEN RAISE EXCEPTION 'COMPANY_ADDRESSES_IOF: It is not allowed to invalidate/delete this type of address'; END IF; mdmappl.MDM_UTIL_ADDRESSES$modify_company_address(p_company_cd => COALESCE(:new_company_cd, :old_company_cd) ,p_address_type_cd  => COALESCE(:new_address_type_cd, :old_address_type_cd) ,p_action_type => 'DELETE'); END;$$;"
        }
    ]
}